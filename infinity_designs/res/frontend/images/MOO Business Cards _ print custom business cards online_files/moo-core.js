//     Underscore.js 1.3.3
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore is freely distributable under the MIT license.
//     Portions of Underscore are inspired or borrowed from Prototype,
//     Oliver Steele's Functional, and John Resig's Micro-Templating.
//     For all details and documentation:
//     http://documentcloud.github.com/underscore

/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */

//      Basilisk 0.1 
//      A simple library for immutable state.
//      
//      (c) 2012 Moo Print Ltd. under an MIT license
//      see http://github.com/moodev/basilisk

/*!
 * URI.js - Mutating URLs
 *
 * Version: 1.6.3
 *
 * Author: Rodney Rehm
 * Web: http://medialize.github.com/URI.js/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *   GPL v3 http://opensource.org/licenses/GPL-3.0
 *
 */

/**
 * @license RequireJS domReady 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/domReady for details
 */

//     (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

define("moo/_ravenReporter",["require"],function(e){var t;return t=function(e){var t={ERROR:"error",WARN:"warning",INFO:"info",DEBUG:"debug"};return function(e,n,r){window.Raven!==undefined&&(t[e]===undefined&&(e="INFO"),e==="ERROR"&&(r&&r instanceof Error?window.Raven.captureException(r,{level:t[e],message:"LIBJS: "+n}):window.Raven.captureMessage("LIBJS: "+n,{level:t[e],extra:r})))}},{makeRavenListener:t}}),define("moo/log",["jquery","./_ravenReporter"],function(e,t){var n=e,r=t.makeRavenListener,i,s,o,u,a,f,l;return o={ERROR:3,WARN:2,INFO:1,DEBUG:0},i=function(e,t){},window&&window.console&&window.console.log&&(i=function(e,t){window.console.log(e,t||"")}),s=function(e,t,n,r){var u,l=t.currentLevel>=0?t.currentLevel:a.currentLevel,c=0,h;if(!o.hasOwnProperty(e)&&o.hasOwnProperty("WARN")){s("WARN","logging level does not exist for message: ("+e+") "+n,r);return}h=o[e],l<=h&&(u="["+e+"] ",t.className&&(u+=t.className+": "),u+=n,r===undefined?i(u):(i(u,r),r.stack&&i(r.stack)));for(c=0;c<f.length;c+=1)try{f[c](e,u,r)}catch(p){i("Could not send message to log listener",p)}},u=function(e){this.className=e,this.currentLevel=-1},u.prototype.error=function(e,t){s("ERROR",this,e,t)},u.prototype.warn=function(e,t){s("WARN",this,e,t)},u.prototype.info=function(e,t){s("INFO",this,e,t)},u.prototype.debug=function(e,t){s("DEBUG",this,e,t)},u.prototype.setLevel=function(e){this.currentLevel=e},a=new u,a.setLevel(o.INFO),f=[r(n)],l=function(){f=[]},{error:function(e,t){a.error(e,t)},warn:function(e,t){a.warn(e,t)},info:function(e,t){a.info(e,t)},debug:function(e,t){a.debug(e,t)},setLevel:function(e){a.setLevel(e)},ERROR:o.ERROR,WARN:o.WARN,DEBUG:o.DEBUG,INFO:o.INFO,logger:function(e){return new u(e)},_testing:{disableMoobugReporting:l}}}),define("moo-core",["require","moo/log"],function(e){var t=e("moo/log");return{log:t}}),function(){function C(e,t,n){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e._chain&&(e=e._wrapped),t._chain&&(t=t._wrapped);if(e.isEqual&&S.isFunction(e.isEqual))return e.isEqual(t);if(t.isEqual&&S.isFunction(t.isEqual))return t.isEqual(e);var r=a.call(e);if(r!=a.call(t))return!1;switch(r){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var i=n.length;while(i--)if(n[i]==e)return!0;n.push(e);var s=0,o=!0;if(r=="[object Array]"){s=e.length,o=s==t.length;if(o)while(s--)if(!(o=s in e==s in t&&C(e[s],t[s],n)))break}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(var u in e)if(S.has(e,u)){s++;if(!(o=S.has(t,u)&&C(e[u],t[u],n)))break}if(o){for(u in t)if(S.has(t,u)&&!(s--))break;o=!s}}return n.pop(),o}var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.slice,u=r.unshift,a=i.toString,f=i.hasOwnProperty,l=r.forEach,c=r.map,h=r.reduce,p=r.reduceRight,d=r.filter,v=r.every,m=r.some,g=r.indexOf,y=r.lastIndexOf,b=Array.isArray,w=Object.keys,E=s.bind,S=function(e){return new P(e)};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=S),exports._=S):e._=S,S.VERSION="1.3.3";var x=S.each=S.forEach=function(e,t,r){if(e==null)return;if(l&&e.forEach===l)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(r,e[i],i,e)===n)return}else for(var o in e)if(S.has(e,o)&&t.call(r,e[o],o,e)===n)return};S.map=S.collect=function(e,t,n){var r=[];return e==null?r:c&&e.map===c?e.map(t,n):(x(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),e.length===+e.length&&(r.length=e.length),r)},S.reduce=S.foldl=S.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(h&&e.reduce===h)return r&&(t=S.bind(t,r)),i?e.reduce(t,n):e.reduce(t);x(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},S.reduceRight=S.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduceRight===p)return r&&(t=S.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=S.toArray(e).reverse();return r&&!i&&(t=S.bind(t,r)),i?S.reduce(s,t,n,r):S.reduce(s,t)},S.find=S.detect=function(e,t,n){var r;return T(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},S.filter=S.select=function(e,t,n){var r=[];return e==null?r:d&&e.filter===d?e.filter(t,n):(x(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},S.reject=function(e,t,n){var r=[];return e==null?r:(x(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r)},S.every=S.all=function(e,t,r){var i=!0;return e==null?i:v&&e.every===v?e.every(t,r):(x(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var T=S.some=S.any=function(e,t,r){t||(t=S.identity);var i=!1;return e==null?i:m&&e.some===m?e.some(t,r):(x(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};S.include=S.contains=function(e,t){var n=!1;return e==null?n:g&&e.indexOf===g?e.indexOf(t)!=-1:(n=T(e,function(e){return e===t}),n)},S.invoke=function(e,t){var n=o.call(arguments,2);return S.map(e,function(e){return(S.isFunction(t)?t||e:e[t]).apply(e,n)})},S.pluck=function(e,t){return S.map(e,function(e){return e[t]})},S.max=function(e,t,n){if(!t&&S.isArray(e)&&e[0]===+e[0])return Math.max.apply(Math,e);if(!t&&S.isEmpty(e))return-Infinity;var r={computed:-Infinity};return x(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},S.min=function(e,t,n){if(!t&&S.isArray(e)&&e[0]===+e[0])return Math.min.apply(Math,e);if(!t&&S.isEmpty(e))return Infinity;var r={computed:Infinity};return x(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},S.shuffle=function(e){var t=[],n;return x(e,function(e,r,i){n=Math.floor(Math.random()*(r+1)),t[r]=t[n],t[n]=e}),t},S.sortBy=function(e,t,n){var r=S.isFunction(t)?t:function(e){return e[t]};return S.pluck(S.map(e,function(e,t,i){return{value:e,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n===void 0?1:r===void 0?-1:n<r?-1:n>r?1:0}),"value")},S.groupBy=function(e,t){var n={},r=S.isFunction(t)?t:function(e){return e[t]};return x(e,function(e,t){var i=r(e,t);(n[i]||(n[i]=[])).push(e)}),n},S.sortedIndex=function(e,t,n){n||(n=S.identity);var r=0,i=e.length;while(r<i){var s=r+i>>1;n(e[s])<n(t)?r=s+1:i=s}return r},S.toArray=function(e){return e?S.isArray(e)?o.call(e):S.isArguments(e)?o.call(e):e.toArray&&S.isFunction(e.toArray)?e.toArray():S.values(e):[]},S.size=function(e){return S.isArray(e)?e.length:S.keys(e).length},S.first=S.head=S.take=function(e,t,n){return t!=null&&!n?o.call(e,0,t):e[0]},S.initial=function(e,t,n){return o.call(e,0,e.length-(t==null||n?1:t))},S.last=function(e,t,n){return t!=null&&!n?o.call(e,Math.max(e.length-t,0)):e[e.length-1]},S.rest=S.tail=function(e,t,n){return o.call(e,t==null||n?1:t)},S.compact=function(e){return S.filter(e,function(e){return!!e})},S.flatten=function(e,t){return S.reduce(e,function(e,n){return S.isArray(n)?e.concat(t?n:S.flatten(n)):(e[e.length]=n,e)},[])},S.without=function(e){return S.difference(e,o.call(arguments,1))},S.uniq=S.unique=function(e,t,n){var r=n?S.map(e,n):e,i=[];return e.length<3&&(t=!0),S.reduce(r,function(n,r,s){if(t?S.last(n)!==r||!n.length:!S.include(n,r))n.push(r),i.push(e[s]);return n},[]),i},S.union=function(){return S.uniq(S.flatten(arguments,!0))},S.intersection=S.intersect=function(e){var t=o.call(arguments,1);return S.filter(S.uniq(e),function(e){return S.every(t,function(t){return S.indexOf(t,e)>=0})})},S.difference=function(e){var t=S.flatten(o.call(arguments,1),!0);return S.filter(e,function(e){return!S.include(t,e)})},S.zip=function(){var e=o.call(arguments),t=S.max(S.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=S.pluck(e,""+r);return n},S.indexOf=function(e,t,n){if(e==null)return-1;var r,i;if(n)return r=S.sortedIndex(e,t),e[r]===t?r:-1;if(g&&e.indexOf===g)return e.indexOf(t);for(r=0,i=e.length;r<i;r++)if(r in e&&e[r]===t)return r;return-1},S.lastIndexOf=function(e,t){if(e==null)return-1;if(y&&e.lastIndexOf===y)return e.lastIndexOf(t);var n=e.length;while(n--)if(n in e&&e[n]===t)return n;return-1},S.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var N=function(){};S.bind=function(t,n){var r,i;if(t.bind===E&&E)return E.apply(t,o.call(arguments,1));if(!S.isFunction(t))throw new TypeError;return i=o.call(arguments,2),r=function(){if(this instanceof r){N.prototype=t.prototype;var e=new N,s=t.apply(e,i.concat(o.call(arguments)));return Object(s)===s?s:e}return t.apply(n,i.concat(o.call(arguments)))}},S.bindAll=function(e){var t=o.call(arguments,1);return t.length==0&&(t=S.functions(e)),x(t,function(t){e[t]=S.bind(e[t],e)}),e},S.memoize=function(e,t){var n={};return t||(t=S.identity),function(){var r=t.apply(this,arguments);return S.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},S.delay=function(e,t){var n=o.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},S.defer=function(e){return S.delay.apply(S,[e,1].concat(o.call(arguments,1)))},S.throttle=function(e,t){var n,r,i,s,o,u,a=S.debounce(function(){o=s=!1},t);return function(){n=this,r=arguments;var f=function(){i=null,o&&e.apply(n,r),a()};return i||(i=setTimeout(f,t)),s?o=!0:u=e.apply(n,r),a(),s=!0,u}},S.debounce=function(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,n||e.apply(i,s)};n&&!r&&e.apply(i,s),clearTimeout(r),r=setTimeout(o,t)}},S.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments))}},S.wrap=function(e,t){return function(){var n=[e].concat(o.call(arguments,0));return t.apply(this,n)}},S.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},S.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},S.keys=w||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)S.has(e,n)&&(t[t.length]=n);return t},S.values=function(e){return S.map(e,S.identity)},S.functions=S.methods=function(e){var t=[];for(var n in e)S.isFunction(e[n])&&t.push(n);return t.sort()},S.extend=function(e){return x(o.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},S.pick=function(e){var t={};return x(S.flatten(o.call(arguments,1)),function(n){n in e&&(t[n]=e[n])}),t},S.defaults=function(e){return x(o.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},S.clone=function(e){return S.isObject(e)?S.isArray(e)?e.slice():S.extend({},e):e},S.tap=function(e,t){return t(e),e},S.isEqual=function(e,t){return C(e,t,[])},S.isEmpty=function(e){if(e==null)return!0;if(S.isArray(e)||S.isString(e))return e.length===0;for(var t in e)if(S.has(e,t))return!1;return!0},S.isElement=function(e){return!!e&&e.nodeType==1},S.isArray=b||function(e){return a.call(e)=="[object Array]"},S.isObject=function(e){return e===Object(e)},S.isArguments=function(e){return a.call(e)=="[object Arguments]"},S.isArguments(arguments)||(S.isArguments=function(e){return!!e&&!!S.has(e,"callee")}),S.isFunction=function(e){return a.call(e)=="[object Function]"},S.isString=function(e){return a.call(e)=="[object String]"},S.isNumber=function(e){return a.call(e)=="[object Number]"},S.isFinite=function(e){return S.isNumber(e)&&isFinite(e)},S.isNaN=function(e){return e!==e},S.isBoolean=function(e){return e===!0||e===!1||a.call(e)=="[object Boolean]"},S.isDate=function(e){return a.call(e)=="[object Date]"},S.isRegExp=function(e){return a.call(e)=="[object RegExp]"},S.isNull=function(e){return e===null},S.isUndefined=function(e){return e===void 0},S.has=function(e,t){return f.call(e,t)},S.noConflict=function(){return e._=t,this},S.identity=function(e){return e},S.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},S.escape=function(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},S.result=function(e,t){if(e==null)return null;var n=e[t];return S.isFunction(n)?n.call(e):n},S.mixin=function(e){x(S.functions(e),function(t){B(t,S[t]=e[t])})};var k=0;S.uniqueId=function(e){var t=k++;return e?e+t:t},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var L=/.^/,A={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(var O in A)A[A[O]]=O;var M=/\\|'|\r|\n|\t|\u2028|\u2029/g,_=/\\(\\|'|r|n|t|u2028|u2029)/g,D=function(e){return e.replace(_,function(e,t){return A[t]})};S.template=function(e,t,n){n=S.defaults(n||{},S.templateSettings);var r="__p+='"+e.replace(M,function(e){return"\\"+A[e]}).replace(n.escape||L,function(e,t){return"'+\n_.escape("+D(t)+")+\n'"}).replace(n.interpolate||L,function(e,t){return"'+\n("+D(t)+")+\n'"}).replace(n.evaluate||L,function(e,t){return"';\n"+D(t)+"\n;__p+='"})+"';\n";n.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+r+"return __p;\n";var i=new Function(n.variable||"obj","_",r);if(t)return i(t,S);var s=function(e){return i.call(this,e,S)};return s.source="function("+(n.variable||"obj")+"){\n"+r+"}",s},S.chain=function(e){return S(e).chain()};var P=function(e){this._wrapped=e};S.prototype=P.prototype;var H=function(e,t){return t?S(e).chain():e},B=function(e,t){P.prototype[e]=function(){var e=o.call(arguments);return u.call(e,this._wrapped),H(t.apply(S,e),this._chain)}};S.mixin(S),x(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];P.prototype[e]=function(){var n=this._wrapped;t.apply(n,arguments);var r=n.length;return(e=="shift"||e=="splice")&&r===0&&delete n[0],H(n,this._chain)}}),x(["concat","join","slice"],function(e){var t=r[e];P.prototype[e]=function(){return H(t.apply(this._wrapped,arguments),this._chain)}}),P.prototype.chain=function(){return this._chain=!0,this},P.prototype.value=function(){return this._wrapped}}.call(this),typeof define!="undefined"&&define.amd&&define("underscore",[],function(){return _}),define("moo/async",["require","jquery","underscore"],function(e){var t=e("jquery"),n=e("underscore"),r,i;return r=function(e){var r={},i=[],s=[];return n.each(e,function(e,t){i.push(t),s.push(e)}),t.when.apply(t,s).pipe(function(){return n.each(arguments,function(e,t){r[i[t]]=e}),r})},i=function(){this._latest=null},n.extend(i.prototype,{submit:function(e){var n=this,r=t.Deferred();return this._latest=r,e.done(function(){if(r!==n._latest)return;r.resolve.apply(r,arguments)}),r.promise()}}),{Deferred:function(){return t.Deferred.apply(t,arguments)},when:function(){return t.when.apply(t,arguments)},whenMap:r,PromiseChannel:i}}),define("moo/strict",["underscore"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;return g=function(e){this.message=e},g.prototype=new Error,t=function(e,t){var n;if(e===undefined||e===null)return t;n=parseFloat(e);if(isNaN(n))throw new Error("Conversion error - cannot convert string to non-NaN number: "+n+" alt: "+t);return n},n=function(e){var n=t(e,undefined);if(n===undefined||n===null)throw new Error("Require a number");return n},r=function(e,t){return e===undefined||e===null?t:e},i=function(e,t){if(e===undefined||e===null)throw new Error("Require a valid string");return e},o=function(e,t){return e===undefined||e===null?t:e},s=function(e){if(e===undefined||e===null)throw new Error("Require a defined object.");return e},u=function(e,t){return e===undefined||e===null?t:e},a=function(e){if(e===undefined||e===null)throw new Error("Require a valid boolean");return e},f=function(e){e=s(e);if(!e.hasOwnProperty("name")||!e.hasOwnProperty("type")||!e.hasOwnProperty("items"))throw new Error("Require an object of type ImageBasket");return e},l=function(e){if(!e.hasOwnProperty("resourceUri")||!e.hasOwnProperty("imageBox")||!e.hasOwnProperty("removable")||!e.hasOwnProperty("croppable")||!e.hasOwnProperty("cacheId")||!e.hasOwnProperty("shouldEnhance")||!e.hasOwnProperty("imageItems"))throw new Error("Require an object of type ImageBasket");return e},c=function(e){if(!e.hasOwnProperty("type")||!e.hasOwnProperty("resourceUri")||!e.hasOwnProperty("width")||!e.hasOwnProperty("height")||!e.hasOwnProperty("rotation"))throw new Error("Require an object of type ImageBasket");return e},h=function(t){if(!e.isFunction(t))throw new Error("Require a function.");return t},p=function(t,n){var r=[];return e.each(n,function(n,i){e.isFunction(n)&&(!t||!t[i])&&r.push(i)}),r},d=function(e,t){return p(e,t).length===0},v=function(e,t){var n;if(!t)throw new g("Interface not provided");n=p(e,t);if(n.length>0)throw new g("Object does not support protocol, missing "+n);return e},m=function(t){e.isFunction(Object.freeze)&&(Object.freeze(t),e.each(t,function(t){e.isObject(t)&&!Object.isFrozen(t)&&m(t)}))},{optNum:t,reqNum:n,requireNumber:n,optStr:r,reqStr:i,requireString:i,optObj:o,reqObj:s,requireObject:s,optBool:u,reqBool:u,requireBoolean:a,requireImageBasket:f,requireImageBasketItem:l,requireImageBasketItemImage:c,reqFunc:h,requireFunction:h,requireProtocol:v,supportsProtocol:d,deepFreeze:m}}),define("moo/onLoadEvents",["jquery"],function(e,t){var n,r=!1;return n=function(t){r||document.readyState==="complete"?t():e(window).load(t)},n(function(){r=!0}),{addOnLoadEvent:n}});var Mustache=typeof module!="undefined"&&module.exports||{};(function(e){function a(e){return u.test(e)}function p(e){return String(e).replace(/&(?!\w+;)|[<>"']/g,function(e){return h[e]||e})}function d(e,t,n,r){r=r||"<template>";var i=t.split("\n"),s=Math.max(n-3,0),o=Math.min(i.length,n+3),u=i.slice(s,o),a;for(var f=0,l=u.length;f<l;++f)a=f+s+1,u[f]=(a===n?" >> ":"    ")+u[f];return e.template=t,e.line=n,e.file=r,e.message=[r+":"+n,u.join("\n"),"",e.message].join("\n"),e}function v(e,t,n){if(e===".")return t[t.length-1];var r=e.split("."),i=r.length-1,s=r[i],o,u,a=t.length,f,l;while(a){l=t.slice(0),u=t[--a],f=0;while(f<i){u=u[r[f++]];if(u==null)break;l.push(u)}if(u&&typeof u=="object"&&s in u){o=u[s];break}}return typeof o=="function"&&(o=o.call(l[l.length-1])),o==null?n:o}function m(e,t,n,r){var i="",u=v(e,t);if(r){if(u==null||u===!1||s(u)&&u.length===0)i+=n()}else if(s(u))o(u,function(e){t.push(e),i+=n(),t.pop()});else if(typeof u=="object")t.push(u),i+=n(),t.pop();else if(typeof u=="function"){var a=t[t.length-1],f=function(e){return S(e,a)};i+=u.call(a,n(),f)||""}else u&&(i+=n());return i}function g(t,n){n=n||{};var r=n.tags||e.tags,i=r[0],s=r[r.length-1],o=['var buffer = "";',"\nvar line = 1;","\ntry {",'\nbuffer += "'],u=[],l=!1,c=!1,h=function(){if(l&&!c&&!n.space)while(u.length)o.splice(u.pop(),1);else u=[];l=!1,c=!1},p=[],v,m,g,y=function(e){r=f(e).split(/\s+/),m=r[0],g=r[r.length-1]},b=function(e){o.push('";',v,'\nvar partial = partials["'+f(e)+'"];',"\nif (partial) {","\n  buffer += render(partial,stack[stack.length - 1],partials);","\n}",'\nbuffer += "')},w=function(e,r){var i=f(e);if(i==="")throw d(new Error("Section name may not be empty"),t,N,n.file);p.push({name:i,inverted:r}),o.push('";',v,'\nvar name = "'+i+'";',"\nvar callback = (function () {","\n  return function () {",'\n    var buffer = "";','\nbuffer += "')},E=function(e){w(e,!0)},S=function(e){var r=f(e),i=p.length!=0&&p[p.length-1].name;if(!i||r!=i)throw d(new Error('Section named "'+r+'" was never opened'),t,N,n.file);var s=p.pop();o.push('";',"\n    return buffer;","\n  };","\n})();"),s.inverted?o.push("\nbuffer += renderSection(name,stack,callback,true);"):o.push("\nbuffer += renderSection(name,stack,callback);"),o.push('\nbuffer += "')},x=function(e){o.push('";',v,'\nbuffer += lookup("'+f(e)+'",stack,"");','\nbuffer += "')},T=function(e){o.push('";',v,'\nbuffer += escapeHTML(lookup("'+f(e)+'",stack,""));','\nbuffer += "')},N=1,C,k;for(var L=0,A=t.length;L<A;++L)if(t.slice(L,L+i.length)===i){L+=i.length,C=t.substr(L,1),v="\nline = "+N+";",m=i,g=s,l=!0;switch(C){case"!":L++,k=null;break;case"=":L++,s="="+s,k=y;break;case">":L++,k=b;break;case"#":L++,k=w;break;case"^":L++,k=E;break;case"/":L++,k=S;break;case"{":s="}"+s;case"&":L++,c=!0,k=x;break;default:c=!0,k=T}var O=t.indexOf(s,L);if(O===-1)throw d(new Error('Tag "'+i+'" was not closed properly'),t,N,n.file);var M=t.substring(L,O);k&&k(M);var _=0;while(~(_=M.indexOf("\n",_)))N++,_++;L=O+s.length-1,i=m,s=g}else{C=t.substr(L,1);switch(C){case'"':case"\\":c=!0,o.push("\\"+C);break;case"\r":break;case"\n":u.push(o.length),o.push("\\n"),h(),N++;break;default:a(C)?u.push(o.length):c=!0,o.push(C)}}if(p.length!=0)throw d(new Error('Section "'+p[p.length-1].name+'" was not closed properly'),t,N,n.file);h(),o.push('";',"\nreturn buffer;","\n} catch (e) { throw {error: e, line: line}; }");var D=o.join("").replace(/buffer \+= "";\n/g,"");return n.debug&&(typeof console!="undefined"&&console.log?console.log(D):typeof print=="function"&&print(D)),D}function y(e,t){var n="view,partials,stack,lookup,escapeHTML,renderSection,render",r=g(e,t),i=new Function(n,r);return function(n,r){r=r||{};var s=[n];try{return i(n,r,s,v,p,m,S)}catch(o){throw d(o.error,e,o.line,t.file)}}}function w(){b={}}function E(e,t){return t=t||{},t.cache!==!1?(b[e]||(b[e]=y(e,t)),b[e]):y(e,t)}function S(e,t,n){return E(e)(t,n)}e.name="mustache.js",e.version="0.5.0-dev",e.tags=["{{","}}"],e.parse=g,e.compile=E,e.render=S,e.clearCache=w,e.to_html=function(e,t,n,r){var i=S(e,t,n);if(typeof r!="function")return i;r(i)};var t=Object.prototype.toString,n=Array.isArray,r=Array.prototype.forEach,i=String.prototype.trim,s;n?s=n:s=function(e){return t.call(e)==="[object Array]"};var o;r?o=function(e,t,n){return r.call(e,t,n)}:o=function(e,t,n){for(var r=0,i=e.length;r<i;++r)t.call(n,e[r],r,e)};var u=/^\s*$/,f;if(i)f=function(e){return e==null?"":i.call(e)};else{var l,c;a("Â ")?(l=/^\s+/,c=/\s+$/):(l=/^[\s\xA0]+/,c=/[\s\xA0]+$/),f=function(e){return e==null?"":String(e).replace(l,"").replace(c,"")}}var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},b={}})(Mustache),typeof define!="undefined"&&define.amd&&define("mustache",[],function(){return Mustache}),define("templating/templating",["jquery","underscore","mustache","moo/log"],function(e,t,n,r){var i=function(i){var s=this,o={},u=[],a={},f=!1,l,c,h,p;i=i||{},i=t.defaults(i,{ajaxSrc:e,preprocessors:[]}),l=i.releaseKey,c=function(e,n){if(t.has(o,e)&&t.has(o[e],n))return o[e][n];throw t.has(o,e)?new Error("Template name: "+n+" not found in URI:"+e):new Error("Template file not loaded from URI: "+e)},p=function(e,t){var n=c(e.uri,e.name);if(n===null)throw"No such template "+e.uri+" or template not yet resolved.";return h(n,t,e.uri,e.partialNames)},h=function(e,r,i,s){var o={};return t.each(s,function(e){var t=c(i,e);t&&(o[e]=t)}),n.render(e,r,o)},t.extend(this,{registerPreprocessor:function(e){if(!t.isFunction(e.wrapTemplatePromise))throw"Template pre-processor must implement wrapTemplatePromise";if(f)throw"Cannot change preprocessors after first render is complete.";u.push(e)},registerUriHandler:function(e,t){if(!/^\w+$/.test(e))throw"URI prefix must contain only letters and numbers.";a[e]=t},render:function(e,t,n,r){var i;f=!0;if(typeof e=="object")return p(e,t);i=c(e,t);if(i===null)throw"No such template "+e+" or template not yet resolved.";return h(i,n,e,r)},getRef:function(e,t,n){return{uri:e,name:t,partialNames:n}},load:t.memoize(function(e){var n,r=function(e){return i.ajaxSrc.ajax({url:e,dataType:"text",data:{q:l}})};return n=t.find(a,function(t,n){var r=n+":";return e.slice(0,r.length)===r?!0:!1}),n=n||r,this._processTemplatePromise(e,n(e))}),_processTemplatePromise:function(n,i){var s=e.Deferred(),a,f=i,l=this;return t.each(u,function(e){f=e.wrapTemplatePromise(f)}),f.done(function(e){try{a=l._parseTemplateBlock(e),o[n]=a}catch(t){r.error("Unable to parse template",t),s.reject(t)}s.resolve(n)}),f.fail(function(e){s.reject(e)}),s.promise()},_parseTemplateBlock:function(e){var t=e.split(/\n/g),n,r,i,s,o="",u={};for(n=0;n<t.length;n+=1)r=t[n],i=r.match(/^@@@ *([a-zA-Z\.\-_]+) *@@@$/),i?(s&&(u[s]=o),s=i[1],o=""):o+=r;return s&&o&&(u[s]=o),u}}),t.each(i.preprocessors,function(e){s.registerPreprocessor(e)})};return{TemplateStore:i,mustache:n}}),function(e,t){typeof exports=="object"?module.exports=t(require("underscore")):typeof define=="function"&&define.amd?define("basilisk",["underscore"],t):e.basilisk=t(e._)}(this,function(e){var t,n=t={};if(!e)throw"Basilisk depends on underscore: please ensure that underscore is loaded first.";var r=function(){};window&&window.console&&window.console.log&&(r=function(){window.console.log.apply(window.console,arguments)});var i=!1,s=Object.defineProperty,o={};try{Object.defineProperty(o,"x",{value:13,writable:!1});try{o.x=14}catch(u){}i=o.x===13}catch(a){i=!1}i?Object.defineProperty(n,"isStrict",{value:!0,writable:!1,enumerable:!0}):n.isStrict=!1,t.struct=function(t){var n,r=e.extend({},t);if(t.with_)throw"You cannot have a property called with_ in your list: this is used within the Basilisk defition system.";return i?n=function(t){var i=this,t=t||{};if(t instanceof n)return t;if(!(i instanceof n))throw"Object must be instantiated with new.";e.each(r,function(n,r){var s=n.filter||e.identity,o;e.has(t,r)&&(o=t[r]),Object.defineProperty(i,r,{value:s(o),writable:!1,enumerable:!0})})}:n=function(t){var i=this,t=t||{},s={};if(t instanceof n)return t;if(!(i instanceof n))throw"Object must be instantiated with new.";e.each(r,function(n,r){var o=n.filter||e.identity,u;e.has(t,r)&&(u=t[r]),i[r]=o(u),s[r]=i[r]}),i.with_=function(t){var o={},u=!1;return e.each(r,function(e,n){var r=e.filter||undefined,i=e.strictEqual||undefined,a,e;Object.hasOwnProperty.call(t,n)?(a=t[n],r?e=r(a):e=a,i?u=u||!i(e,s[n]):u=u||e!==s[n],o[n]=e):o[n]=s[n]}),u?new n(o):i}},n.prototype.with_=function(t){var i=this,s={},o=!1;return e.each(r,function(e,n){var r=e.filter||undefined,u=e.strictEqual||undefined,a,e;Object.hasOwnProperty.call(t,n)?(a=t[n],r?e=r(a):e=a,u?o=o||!u(e,i[n]):o=o||e!==i[n],s[n]=e):s[n]=i[n]}),o?new n(s):i},n._properties=function(){return r.slice(0,r.length)},e.each(r,function(e,t){var r=t;r=r.charAt(0).toUpperCase()+r.slice(1,r.length),r="with"+r,n.prototype[r]=function(e){var n={};return n[t]=e,this.with_(n)}}),n},t.definitions={},n.definitions.makeConstructor=t.struct,n.properties={"float":{strictEquals:function(e,t){return Math.abs(e-t)<1e-5}}},t.watchers={},t.watchers.path=function(t,n){var r=t.split("."),i=function(t,r,s){var o=t.shift(),u,a;if(r===s)return;s!==undefined&&e.has(s,o)&&(a=s[o]),r!==undefined&&e.has(r,o)&&(u=r[o]),t.length==0?u!==a&&n(u,a):i(t,u,a)};return function(e,t){i(r.slice(0,r.length),e,t)}},t.utils={},t.utils.Path=function(e){var n=t.collections.ForwardList.from(e.split("."));this.parts=function(){return n}},e.extend(t.utils.Path.prototype,{consume:function(e,t){var n=e,t=!!t;arguments.length===1&&(t=!0);if(e===undefined&&!t)throw"Cannot root on undefined struct when not tolerant.";return this.parts().each(function(e){if(n===undefined)return;if(!t&&!n.hasOwnProperty(e))throw"Cannot find part: "+e;n=n[e]}),n},replace:function(e,n){var r=t.collections.ForwardList.from([]),i=e;return this.parts().each(function(e){r=r.shift([e,i]);if(!i.hasOwnProperty(e))throw"Cannot follow path: node lacks "+e;i=i[e]}),i=n,r.each(function(e){var t=e[0],n=e[1],r={};r[t]=i,i=n.with_(r)}),i},swap:function(e,t){var n=this.consume(e,!1),r=[n];return r.push.apply(r,Array.prototype.slice.call(arguments,2)),this.replace(e,t.apply(undefined,r))}}),t.collections={};var f=function(t,n){var r=n||e.uniqueId("__basilisk-fn-oncePerInstance");return function(){var e;if(arguments.length>0)throw"Cannot supply any arguments to a once-per-instance function.";return this.hasOwnProperty(r)||(e=t.apply(this,[]),i?Object.defineProperty(this,r,{value:e,writable:!1,enumerable:!1}):this[r]=e),this[r]}};return e.extend(t.collections,{ForwardListNode:n.definitions.makeConstructor({rest:{noWith:!0},value:{}}),ForwardList:n.definitions.makeConstructor({head:{}})}),t.collections.ForwardListNode.prototype.length=f(function(){return this.rest?1+this.rest.length():1},"_length"),e.extend(t.collections.ForwardList.prototype,{shift:function(e){var n=this;return new t.collections.ForwardList({head:new t.collections.ForwardListNode({rest:n.head,value:e})})},length:f(function(){return this.head?this.head.length():0},"_length"),unshift:function(){var e=this,n=undefined;return e.head?(n=e.head.rest,[this.head.value,new t.collections.ForwardList({head:n})]):e},each:function(e,t){var n=0,r=this.head;while(r!==undefined&&r!==null)e.apply(t,[r.value,n,this,r]),n+=1,r=r.rest},filter:function(e,n){var r=[],i=!1;return this.each(function(t,n,s,o){e.apply(this,arguments)?r.push(t):i=!0}),i?t.collections.ForwardList.from(r):this},first:function(e,t){var n=0,e=e||function(){return!0},r=this.head;while(r!==undefined&&r!==null){if(e.apply(t,[r.value,n,this,r]))return r.value;n+=1,r=r.rest}return undefined}}),t.collections.ForwardList.from=function(n){return n instanceof t.collections.ForwardList?n:e.reduceRight(n,function(e,t){return e.shift(t)},new t.collections.ForwardList({head:null}))},n.Atom=function(r,i){if(!(this instanceof n.Atom))throw"Please instantiate each atom separately.";var s,o=this,u=t.collections.ForwardList.from([]),a=function(e){var t=s;if(e!==s){if(!i(e,s))throw"Value does not pass validator.";s=e,u.each(function(e){try{e(s,t)}catch(n){}})}return s};i=i||function(){return!0},e.extend(o,{deref:function(){return s},swap:function(t){var n,r=[s];return arguments.length>1&&r.push.apply(r,e.rest(argument)),n=t.apply(null,r),this.compareAndSet(s,n)},compareAndSet:function(e,t){return e===s?a(t)===t:!1},addWatcher:function(e){u.first(function(t){return t===e})===undefined&&(u=u.shift(e))},removeWatcher:function(e){u=u.filter(function(t){return t!==e})},watchers:function(){return u}}),this.cas=this.compareAndSet,a(r)},n}),define("moo/environment",["require","basilisk"],function(e){var t=e("basilisk"),n;return n=t.struct({www:{},secure:{},releaseKey:{},languageCode:{},currencyCode:{},websiteName:{}}),{Environment:n}}),define("service/environment",["require","jquery","underscore","moo/environment","moo/log"],function(e){var t=e("jquery"),n=e("underscore"),r=e("moo/environment").Environment,i=e("moo/log").logger("environment"),s,o=t('script[src*="?q="]').first().attr("src"),u,a,f={},l,c,h=t("html");return!o||!o.match(/q=([A-Za-z0-9_\-]*)$/)?(i.warn("Unable to determine QTag. Using *EMPTY* string to prevent long-caching. "),s=""):(u=o.match(/q=([A-Za-z0-9_\-]*)$/),s=u[1]),a=h.attr("lang")||h.attr("xml:lang")||"en",n.isString(a)||(i.warn("Unable to detect page language: defaulting to base language (en)"),a="en"),l=window||f,l===f&&i.error("Unable to detect global scope."),!n.has(l,"pageData")||!n.has(l.pageData,"wwwServer")||!n.has(l.pageData,"secureServer")||!n.has(l.pageData,"userCurrencyCode")||!n.has(l.pageData,"websiteName")?(i.error("Unable to find page data or does not have secure/www info/currency."),c={secureServer:"",wwwServer:"",userCurrencyCode:"USD",websiteName:"MOO_US"}):c=l.pageData,{env:new r({releaseKey:s,www:c.wwwServer,secure:c.secureServer,languageCode:a,currencyCode:c.userCurrencyCode,websiteName:c.websiteName})}}),define("service/releaseKey",["require","service/environment"],function(e){var t=e("service/environment").env;return t.releaseKey}),define("cms/splat",["jquery","underscore","moo/log"],function(e,t,n){var r,i,s,o,u,a,f,l,c;return r=function(e){var n=this;if(!t.isFunction(e.fetchJSON))throw"Must provide a CMSService to the the TranslationPreprocessor.";t.extend(n,{cmsService:function(){return e}})},t.extend(r.prototype,{_fetchCmsDocuments:function(n){var r=[],i=[];return n.length===1?this.cmsService().fetchJSON(n[0]):(t.each(n,function(e){var t=this.cmsService().fetchJSON(e).pipe(function(e){return i.push(e),null});r.push(t)},this),e.when.apply(e,r).pipe(function(){return i}))},wrapTemplatePromise:function(r){var i=e.Deferred(),s,o=this;if(!t.isFunction(r.done))throw"untranslated template must be a Promise.";return s=r,s.done(function(r){var s=/^@@@/m,u=/^i18n:([\w\W]*)$/,a,f,h,p,d;if(!s.test(r))return i.resolve(r);p=r.split(/\n/g),d=[],a=[],t.each(p,function(t){var n=t.match(u);n?a.push(e.trim(n[1])):d.push(t)});if(!a.length)return i.resolve(r);d=d.join("\n"),f=o._fetchCmsDocuments(a);try{h=l(d)}catch(v){return n.error("Unable to convert template to splat array",v),i.reject(v)}f.fail(function(e){i.reject(e)}),f.done(function(e){var t;try{t=c(h,e)}catch(r){n.error("Unable to merge splats with document",r),i.reject(r)}i.resolve(t)})}),s.fail(function(e){i.reject(e)}),i.promise()}}),s=function(e,n){var r=e;return t.each(n,function(e,n){var i="{$"+n+"}",s="";t.each(r.split(i),function(t,n,r){s+=t,n!==r.length-1&&(s+=e)}),r=s}),r},f="(?:\\{i18n\\s+([\\w\\.]+)((?:\\s*\\$[\\w]+=\\{\\{\\{?[\\w\\.]+\\}?\\}\\})*)\\s*/\\})",u=new RegExp(f,"m"),a=/\s*\$(\w+)=(\{\{\{?[\w\.]+\}?\}\})/g,o=function(e,n){var r=this;if(!r instanceof o)throw"Please instantiate using new.";n=n||{},t.extend(r,{fieldPath:function(){return e},argumentMap:function(){return n}})},o.render=function(e,t,n){var r=new o(t,n);return r.render(e)},t.extend(o.prototype,{render:function(e){var n;if(t.isArray(e)){t.each(e,function(e){if(n)return;n=e.path(this.fieldPath(),!1,!1)},this);if(!n)throw new Error('Could not find "'+this.fieldPath()+'" in any of the provided CMS documents')}else n=e.path(this.fieldPath());return s(n,this.argumentMap())}}),l=function(e){var t=e,n=[],r,i,s;while(u.test(t)){r=t.match(u),r.index>0&&n.push(t.slice(0,r.index)),i=i=a.exec(r[2]),s={};while(i!==null)s[i[1]]=i[2],i=a.exec(r[2]);n.push(new o(r[1],s)),t=t.slice(r.index+r[0].length),r=null}return t.length>0&&n.push(t),n},c=function(e,n){var r="";return t.each(e,function(e){t.isString(e)?r+=e:r+=e.render(n)}),r},i=function(n,r,i){var s=this;i=i||e,t.extend(s,{createHandlerFn:function(){var e=/^cms:\/\/([\w\/.\-_]+);template=([\w\W]+)$/;return function(t){var s=t.match(e),o,u;if(!s)throw"Malformed cms: uri - must be of the form cms://</path/to/cmsdoc.json>;template=</path/to/template>";return o=s[1],u=s[2],n.fetchJSON(o),i.ajax({url:u,dataType:"text",data:{q:r}}).pipe(function(e){return"i18n: "+o+"\n"+e})}}})},{TranslationPreprocessor:r,CMSURIHandler:i,splat:s,SplatTag:o,textToSplatArray:l,mergeSplatArrayWithDocument:c}}),define("cms/cms",["require","underscore","jquery","moo/log","cms/splat"],function(e){var t=e("underscore"),n=e("jquery"),r=n,i=e("moo/log").logger("cms.cms"),s=e("cms/splat"),o,u,a,f,l,c,h,p,d,v,m,g=/^(\w+)\./,y,b,w,E;return b=function(e,t){if(!e instanceof t)throw"Please instantiate using new."},o=function(e){var i=e.ajaxSrc||r,s=this,a=e.translatorFn||E();b(this,o),this.options=e,t.extend(s,{_fetch:t.memoize(function(e){var t=n.Deferred();return i.ajax({url:e,dataType:"json",type:"GET"}).done(function(e){var n;try{n=new u({fields:m(e)})}catch(r){throw t.reject("Invalid CMS document"),r}n&&t.resolve(n)}).fail(function(e){t.resolve(e)}),t.promise()}),fetchJSON:t.memoize(function(e){return this._fetch(a(e))}),fetchUntranslatedJSON:t.memoize(function(e){return this._fetch("/us"+e)}),_ajaxSrc:function(){return i}})},y=function(e){var t=g.exec(e);return t?{head:t[1],tail:e.slice(t[0].length+t.index)}:{head:e,tail:""}},u=function(e){var n=e.fields;b(this,u),t.extend(this,{fields:function(){return n}})},t.extend(u.prototype,{path:function(e,t,n){var r;return t=!!t,n===undefined&&(n=!0),this._consumeFrom(this.fields(),e,t,n)},_consumeFrom:function(e,n,r,i){var s,o;if(n===""){if(!r){if(!t.isFunction(e.content))throw"Cannot consume content on final node: type lacks a content function";return e.content()}return e}s=y(n);if(!t.isFunction(e.field))throw"Cannot descend into a node that lacks fields.";o=e.field(s.head);if(!t.isObject(o)){if(i)throw"No such node "+s.head+" in subpath: "+n;return undefined}return this._consumeFrom(o,s.tail,r,i)}}),a=function(e){this._documents=e},t.extend(a.prototype,{path:function(e,n,r){r===undefined&&(r=!0);var i=null;t.each(this._documents,function(t){if(i)return;i=t.path(e,!1,!1)},this);if(!i&&r)throw"Path not found: "+e;return i}}),f=function(e,t){var n=t.type;e.type=function(){return n}},l=function(e){var n=e.content,r=this;b(this,l),f(this,e),t.extend(r,{content:function(){return n}})},t.extend(l,{fromJSON:function(e){return new l(e)}}),c=function(e){var n=e.content,r=this;b(this,l),f(this,e),t.extend(r,{content:function(){return n}})},t.extend(c,{fromJSON:function(e){return new c(e)}}),h=function(e){var r=n("<img>"),i;b(this,h),f(this,e),t.each(e.content,function(e,t){r.attr(t,e)}),i=n("<div>").append(r).html(),t.extend(this,{spec:function(){return e.content},content:function(){return i}})},t.extend(h,{fromJSON:function(e){return new h(e)}}),p=function(e){var r=n("<a>"),i;b(this,p),f(this,e),t.each(e.content,function(e,t){if(t==="text")return;r.attr(t,e)}),r.text(e.content.text),i=n("<div>").append(r).html(),t.extend(this,{spec:function(){return e.content},content:function(){return i}})},t.extend(p,{fromJSON:function(e){return new p(e)}}),d=function(e){var n=e.fields,r=this;b(this,d),f(this,e),t.extend(r,{each:function(e){t.each(n,function(t,n){e(t,n)})},field:function(e){return n[e]}})},t.extend(d,{fromJSON:function(e){var n={};return t.each(e.fields,function(e,t){n[t]=m(e)}),new d({fields:n,type:"fieldList"})}}),v={html:c,text:l,image:h,link:p,fieldList:d},m=function(e,t){var n=null;t=t||v;if(!t.hasOwnProperty(e.type))throw"Unknown field type: "+e.type;return n=t[e.type],n.fromJSON(e)},w=t.identity,E=function(){return function(e){var t=n("html").attr("data-localised-base-path")||"/",r=new RegExp("^"+t,"i");if(e==="")e="/";else if(e.charAt(0)!=="/")throw"You must provide an absolute, untranslated url to the DOM translator. Url: "+e;return r.test(e)?e:t+e}},{CMSService:o,jsonToField:m,TextField:l,HTMLField:c,FieldListField:d,Content:u,ContentStack:a,makeDOMTranslator:E}}),define("service/cms",["cms/cms"],function(e){return new e.CMSService({translatorFn:e.makeDOMTranslator()})}),define("templating/force-fail",["jquery"],function(e){var t=function(){var t=function(){var e="forceFailTemplateLoading";return location&&location.hash.indexOf(e)>=0?!0:!1};return{shouldBeLoaded:t(),wrapTemplatePromise:function(){var n=e.Deferred();return t()?n.reject("Trying to make service fail, on purpose."):n.resolve(),n}}};return t()}),define("service/templating",["require","jquery","templating/templating","service/releaseKey","service/cms","cms/splat","templating/force-fail"],function(e){var t=e("jquery"),n=e("templating/templating"),r=e("service/releaseKey"),i=e("service/cms"),s=e("cms/splat"),o=e("templating/force-fail"),u=[new s.TranslationPreprocessor(i)],a,f=t;return o.shouldBeLoaded&&u.push(o),a=new n.TemplateStore({ajaxSrc:f,preprocessors:u,releaseKey:r}),a.registerUriHandler("cms",(new s.CMSURIHandler(i,r,f)).createHandlerFn()),a}),define("templating/templating-jquery",["jquery","service/templating"],function(e,t){e.fn.render=function(){return this.html(t.render.apply(t,arguments))},e.extend({render:function(){var t=e("<div></div>");return t.render.apply(t,arguments).children()}})}),define("moo/link",["require","underscore","service/environment"],function(e){var t=e("underscore"),n=e("service/environment").env,r=function(e){return n.www+e},i=function(e){return n.secure+e};return{localised:t.memoize(r),secure:t.memoize(i)}}),define("moo/data",["underscore","basilisk","moo/strict"],function(e,t,n){var r,i,s,o,u,a=t.struct;return i=a({x:{},y:{}}),e.extend(i.prototype,{equals:function(e){return this.x===e.x&&this.y===e.y},toString:function(){return"Point["+this.x+","+this.y+"]"}}),r=a({type:{},r:{},g:{},b:{},c:{},m:{},y:{},k:{}}),e.extend(r.prototype,{equals:function(e){return this.type!==e.type?!1:this.type==="RGB"?this.r===e.r&&this.g===e.g&&this.b===e.b:this.c===e.c&&this.m===e.m&&this.y===e.y&&this.k===e.k},toString:function(){return this.kind==="RGB"?"[Colour (RGB) r:"+this.r+" g:"+this.g+" b:"+this.b+"]":"[Colour (CMYK) c:"+this.c()+" m:"+this.m()+" y:"+this.y()+" k:"+this.k()+"]"}}),s=a({width:{},height:{}}),e.extend(s.prototype,{equals:function(e){return this.width===e.width&&this.height===e.height}}),o=a({center:{},width:{},height:{},angle:{},cornerRadius:{filter:function(e){return e||0}}}),e.extend(o.prototype,{equals:function(e){return this.center.equals(e.center)&&this.width===e.width&&this.height===e.height&&this.angle===e.angle&&this.cornerRadius===e.cornerRadius},toString:function(){return"BoundingBox["+this.center+", "+this.width+"x"+this.height+", angle="+this.angle+", cornerRadius="+this.cornerRadius+"]"}}),u=a({family:{},bold:{filter:function(e){return!!e}},italic:{filter:function(e){return!!e}}}),e.extend(u.prototype,{equals:function(e){return this.family===e.family&&this.bold===e.bold&&this.italic===e.italic},toString:function(){return"Font["+this.family+" Bold:"+this.bold+" Italic:"+this.italic+" ]"}}),{Colour:r,Point:i,BoundingBox:o,Font:u,Area:s}}),define("moo/side",["underscore","basilisk","moo/data"],function(e,t,n){var r,i,s,o,u,a,f,l,c=t.struct;return l=function(){throw"Object has been initialised: you cannot call init again."},r={type:{},linkId:{}},i=e.extend({text:{},font:{},colour:{},pointSize:{},alignment:{}},r),s=c(i),o=c(i),u=c(e.extend({imageBox:{},resourceUri:{},imageStoreFileId:{},enhance:{filter:function(e){return!!e}}},r)),a=c(e.extend({resourceUri:{}},r)),f=c(e.extend({colour:{}},r)),{TextData:s,MultiLineTextData:o,ImageData:u,FixedImageData:a,BoxData:f}}),define("moo/pack",["jquery","underscore","basilisk","moo/data","moo/side","moo/log"],function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m;return m=function(){throw"Object has been initialised: you cannot call init again."},v=function(){throw"Object has not yet been initialised."},o=n.struct({sideNum:{},type:{},templateCode:{},data:{filter:function(e){return n.collections.ForwardList.from(e)}}}),t.extend(o.prototype,{getDatumByLinkId:function(e){return this.filterDatums(e).first()},filterDatums:function(e,t){return this.data.filter(function(n){var r=!0;return e!==undefined&&e!==null&&e!==n.linkId&&(r=!1),t!==undefined&&t!==null&&!(n instanceof t)&&(r=!1),r})},filterDatumByTypes:function(){var e=Array.prototype.slice.call(arguments);return this.data.filter(function(n){var r=!1;return t.each(e,function(e){n instanceof e&&(r=!0)}),r})},byReplacingDatum:function(e){var t=this,n;return n=this.data.filter(function(t){return t.linkId!==e.linkId}),n=n.shift(e),t.withData(n)}}),u=n.struct({packId:{},productCode:{},productVersion:{},numCards:{},sides:{filter:function(e){return n.collections.ForwardList.from(e)}},cards:{filter:function(e){return n.collections.ForwardList.from(e)}},extras:{filter:function(e){return n.collections.ForwardList.from(e)}},imageBasket:{}}),t.extend(u.prototype,{ImageBasketItemWarnings:[],addImageBasketItemWarning:function(e,t){this.ImageBasketItemWarnings[e]=t},getImageBasketItemWarning:function(e){return this.ImageBasketItemWarnings[e]},sideByTypeAndNum:function(e,t){return this.sides.first(function(n){return n.type===e&&n.sideNum===t})},sideBySideKey:function(e){return this.sides.first(function(t){return t.type===e.sideType&&t.sideNum===e.sideNum})},byReplacingSide:function(e){var t=this,n;return n=this.sides.filter(function(t){return t.sideNum!==e.sideNum||t.type!==e.type}),n=n.shift(e),t.withSides(n)},byReplacingExtra:function(e){var t=this,n;return n=this.extras.filter(function(t){return t.key!==e.key||t.value!==e.value}),n=n.shift(e),t.withExtras(n)}}),a=n.struct({cardNum:{},cardSides:{filter:function(e){return n.collections.ForwardList.from(e)}}}),f=n.struct({sideNum:{},sideType:{}}),l=n.struct({key:{},value:{}}),h=n.struct({resourceUri:{},imageBox:{},removable:{filter:function(e){return!!e}},croppable:{filter:function(e){return!!e}},cacheId:{},shouldEnhance:{filter:function(e){return!!e}},name:{},source:{},imageItems:{filter:function(e){return n.collections.ForwardList.from(e)}}}),t.extend(h.prototype,{imageForType:function(e){return this.imageItems.first(function(t){return t.type===e})},isVector:function(){return/\.pdf$/.test(this.resourceUri)}}),p=n.struct({type:{},resourceUri:{},width:{},height:{},rotation:{}}),p.PRINT="print",p.PREVIEW="preview",p.SMALL_PREVIEW="small-preview",p.THUMBNAIL="thumbnail",c=n.struct({immutable:{filter:function(e){return!!e}},name:{},type:{},items:{filter:function(e){return n.collections.ForwardList.from(e)}}}),t.extend(c.prototype,{itemForResourceUri:function(e){return this.items.first(function(t){return t.resourceUri===e})},imageForResourceUriAndType:function(e,t){var n=this.itemForResourceUri(e);return n&&n.imageForType(t)||undefined},addImageBasketItem:function(e){return this.itemForResourceUri(e.resourceUri)!==undefined?(s.warn("ImageBasketItem already exists in ImageBasket",e.resourceUri),this):(s.debug("ImageBasketItem added to ImageBasket",e.resourceUri),this.withItems(this.items.shift(e)))},removeImageBasketItem:function(e){return this.withItems(this.items.filter(function(t){return t!==e}))}}),d=n.struct({productType:{},packSize:{},paperClass:{},finishingOption:{},paperLaminate:{}}),{Pack:u,Side:o,Extra:l,Card:a,CardSide:f,ImageBasket:c,ImageBasketItem:h,ImageBasketItemImage:p,PhysicalSpec:d}}),define("moo/pack/json",["underscore","basilisk","moo/pack","moo/data","moo/side","moo/strict","moo/log"],function(e,t,n,r,i,s,o){var u,a,f=s.reqObj,l=s.reqNum,c=s.reqStr,h=s.optNum,p=s.optStr;return u=function(){},u.prototype.toBoundingBox=function(e){return e===null||e===undefined?undefined:new r.BoundingBox({center:f(this.toPoint(e.center)),width:l(e.width),height:l(e.height),angle:l(e.angle),cornerRadius:h(e.cornerRadius,0)})},u.prototype.toPoint=function(e){return e===null||e===undefined?undefined:new r.Point({x:l(e.x),y:l(e.y)})},u.prototype.toColour=function(e){return e===null||e===undefined?undefined:new r.Colour({type:e.type,r:h(e.r,undefined),g:h(e.g,undefined),b:h(e.b,undefined),c:h(e.c,undefined),m:h(e.m,undefined),y:h(e.y,undefined),k:h(e.k,undefined)})},u.prototype.toFont=function(e){return e===null||e===undefined?undefined:new r.Font({family:e.fontFamily,bold:!!e.bold,italic:!!e.italic})},u.prototype.toBoxData=function(e){return e===null||e===undefined?undefined:new i.BoxData({type:e.type,colour:this.toColour(e.colour),linkId:c(e.linkId)})},u.prototype.toImageData=function(e){return e===null||e===undefined?undefined:new i.ImageData({type:e.type,imageBox:this.toBoundingBox(e.imageBox),linkId:c(e.linkId),resourceUri:e.resourceUri,imageStoreFileId:e.imageStoreFileId,enhance:!!e.enhance})},u.prototype.toFixedImageData=function(e){return e===null||e===undefined?undefined:new i.ImageData({type:e.type,linkId:c(e.linkId),resourceUri:e.resourceUri})},u.prototype.toTextData=function(e){return e===null||e===undefined?undefined:new i.TextData({type:e.type,linkId:c(e.linkId),text:p(e.text,undefined),font:this.toFont(e.font),colour:this.toColour(e.colour),pointSize:h(e.pointSize,undefined),alignment:p(e.alignment,undefined)})},u.prototype.toMultiLineTextData=function(e){return e===null||e===undefined?undefined:new i.TextData({type:e.type,linkId:c(e.linkId),text:p(e.text,undefined),font:this.toFont(e.font),colour:this.toColour(e.colour),pointSize:h(e.pointSize,undefined),alignment:p(e.alignment,undefined)})},u.prototype.toDatum=function(e){if(e===null||e===undefined)return undefined;if(e.type==="boxData")return this.toBoxData(e);if(e.type==="imageData")return this.toImageData(e);if(e.type==="fixedImageData")return this.toFixedImageData(e);if(e.type==="textData")return this.toTextData(e);if(e.type==="multiLineTextData")return this.toMultiLineTextData(e);throw"Json Type Not supported yet: "+e.type},u.prototype.toImageBasketItemImage=function(e){return e===null||e===undefined?undefined:new n.ImageBasketItemImage({width:l(e.width),height:l(e.height),type:c(e.type),resourceUri:c(e.resourceUri),rotation:l(e.rotation)})},u.prototype.toImageBasketItem=function(e){if(e===null||e===undefined)return undefined;var t,r=[];for(t=0;t<e.imageItems.length;t+=1)e.imageItems[t]!==undefined&&r.push(this.toImageBasketItemImage(e.imageItems[t]));return new n.ImageBasketItem({resourceUri:e.resourceUri,imageBox:this.toBoundingBox(e.imageBox),removable:!!e.removable,croppable:!!e.croppable,cacheId:e.cacheId,shouldEnhance:!!e.shouldEnhance,imageItems:r,name:e.name,source:e.source})},u.prototype.toImageBasket=function(e){var t,r=[];if(e===null||e===undefined)return undefined;for(t=0;t<e.items.length;t+=1)e.items[t]!==undefined&&r.push(this.toImageBasketItem(e.items[t]));return new n.ImageBasket({items:r,immutable:!!e.immutable,name:e.name||undefined,type:e.type||undefined})},u.prototype.toSide=function(e){var t,r=[];if(e===null||e===undefined)return undefined;for(t=0;t<e.data.length;t+=1)e.data[t]!==undefined&&r.push(this.toDatum(e.data[t]));return new n.Side({sideNum:e.sideNum,type:e.type,templateCode:e.templateCode,data:r})},u.prototype.toExtras=function(r){var i=[];return r===null||r===undefined?null:(e.each(r,function(e){i.push(new n.Extra({key:c(e.key),value:p(e.value)}))}),t.collections.ForwardList.from(i))},u.prototype.toCards=function(r){var i=[];return r===null||r===undefined?null:(e.each(r,function(r){var s=[];e.each(r.cardSides||[],function(e){s.push(new n.CardSide({sideType:c(e.sideType),sideNum:l(e.sideNum)}))}),i.push(new n.Card({cardNum:l(r.cardNum),cardSides:t.collections.ForwardList.from(s)}))}),t.collections.ForwardList.from(i))},u.prototype.toPack=function(e){var t,r=[];if(e===null)return null;for(t=0;t<e.sides.length;t+=1)e.sides[t]!==undefined&&r.push(this.toSide(e.sides[t]));return new n.Pack({packId:h(e.packId),productCode:e.productCode,productVersion:e.productVersion,extras:this.toExtras(e.extras),cards:this.toCards(e.cards),numCards:e.numCards,sides:r,imageBasket:this.toImageBasket(e.imageBasket)})},u.prototype.toPhysicalSpec=function(e){return new n.PhysicalSpec({productType:e.productType,packSize:l(e.packSize),paperClass:e.paperClass,finishingOption:e.finishingOption,paperLaminate:e.paperLaminate})},a=function(){},a.prototype.toBoundingBox=function(e){return e===null||e===undefined?undefined:{center:this.toPoint(e.center),width:e.width,height:e.height,angle:e.angle,cornerRadius:e.cornerRadius}},a.prototype.toPoint=function(e){return e===null||e===undefined?undefined:{x:e.x,y:e.y}},a.prototype.toColour=function(e){return e===null||e===undefined?undefined:{type:e.type,r:e.r,g:e.g,b:e.b,c:e.c,m:e.m,y:e.y,k:e.k}},a.prototype.toFont=function(e){return e===null||e===undefined?undefined:{fontFamily:e.family,bold:e.bold,italic:e.italic}},a.prototype.toBoxData=function(e){return e===null||e===undefined?undefined:{colour:this.toColour(e.colour),linkId:e.linkId,type:"boxData"}},a.prototype.toImageData=function(e){return e===null||e===undefined?undefined:{imageBox:this.toBoundingBox(e.imageBox),linkId:e.linkId,resourceUri:e.resourceUri,imageStoreFileId:e.imageStoreFileId,enhance:e.enhance,type:"imageData"}},a.prototype.toFixedImageData=function(e){return e===null||e===undefined?undefined:{linkId:e.linkId,resourceUri:e.resourceUri,type:"fixedImageData"}},a.prototype.toTextData=function(e){return e===null||e===undefined?undefined:{linkId:e.linkId,text:e.text,font:this.toFont(e.font),colour:this.toColour(e.colour),pointSize:e.pointSize,alignment:e.alignment,type:"textData"}},a.prototype.toMultiLineTextData=function(e){return e===null||e===undefined?undefined:{linkId:e.linkId,text:e.text,font:this.toFont(e.font),colour:this.toColour(e.colour),pointSize:e.pointSize,alignment:e.alignment,type:"multiLineTextData"}},a.prototype.toDatum=function(e){if(e===null||e===undefined)return undefined;if(e.type==="boxData")return this.toBoxData(e);if(e.type==="imageData")return this.toImageData(e);if(e.type==="fixedImageData")return this.toFixedImageData(e);if(e.type==="textData")return this.toTextData(e);if(e.type==="multiLineTextData")return this.toMultiLineTextData(e);throw"Obj Type Not supported yet: "+e.type},a.prototype.toImageBasketItemImage=function(e){return e===null||e===undefined?undefined:{width:e.width,height:e.height,type:e.type,resourceUri:e.resourceUri,rotation:e.rotation}},a.prototype.toImageBasketItem=function(e){if(e===null||e===undefined)return undefined;var t=this,n=[];return e.imageItems.each(function(e){n.push(t.toImageBasketItemImage(e))}),{resourceUri:e.resourceUri,imageBox:this.toBoundingBox(e.imageBox),removable:e.removable,croppable:e.croppable,cacheId:e.cacheId,shouldEnhance:e.shouldEnhance,name:e.name,source:e.source,imageItems:n}},a.prototype.toImageBasket=function(e){var t=this,n=[];return e===null||e===undefined?undefined:(e.items.each(function(e){n.push(t.toImageBasketItem(e))}),{items:n,immutable:e.immutable,name:e.name,type:e.type})},a.prototype.toExtras=function(e){var t=[];return e===null||e===undefined?null:(e.each(function(e){t.push(new n.Extra({key:c(e.key),value:p(e.value)}))}),t)},a.prototype.toCards=function(e){var t=[];return e===null||e===undefined?null:(e.each(function(e){var n=[];e.cardSides.each(function(e){n.push({sideType:e.sideType,sideNum:e.sideNum})}),t.push({cardNum:e.cardNum,cardSides:n})}),t)},a.prototype.toSide=function(e){var t=this,n=[];return e===null||e===undefined?undefined:(e.data.each(function(e){n.push(t.toDatum(e))}),{sideNum:e.sideNum,type:e.type,templateCode:e.templateCode,data:n})},a.prototype.toOverlayArray=function(e){var t,i,s=[];if(e===null||e===undefined)return undefined;for(t=0;t<e.length;t++){r=[];for(i=0;i<e[t].data.length;i++)e.data[i]!==undefined&&r.push(this.toDatum(e[t].data[i]));s.push(new n.Side({sideNum:e[t].sideNum,type:e[t].type,templateCode:e[t].templateCode,data:r}))}return s},a.prototype.toPack=function(e){var t=this,n=[];return e===null?null:(e.sides.each(function(e){n.push(t.toSide(e))}),{packId:e.packId,productCode:e.productCode,productVersion:e.productVersion,numCards:e.numCards,sides:n,imageBasket:this.toImageBasket(e.imageBasket),cards:this.toCards(e.cards),extras:this.toExtras(e.extras)})},a.prototype.toPhysicalSpec=function(e){return{productType:e.productType,packSize:e.packSize,paperClass:e.paperClass,finishingOption:e.finishingOption,paperLaminate:e.paperLaminate}},{FromJSONObj:u,ToJSONObj:a}}),define("moo/measurement/measurement",["require","basilisk"],function(e){var t=e("basilisk"),n=t.struct({width:{},height:{},numberOfLines:{},fontSubstituted:{filter:function(e){return!!e}}});return{TextMeasurement:n}}),define("moo/measurement/json",["require","moo/strict","moo/measurement/measurement"],function(e){var t=e("moo/strict"),n=e("moo/measurement/measurement").TextMeasurement,r=function(){};return r.prototype.toTextMeasurement=function(e){return e===null||e===undefined?undefined:new n({width:t.reqNum(e.textWidth),height:t.reqNum(e.textHeight),numberOfLines:t.reqNum(e.numberOfLines),fontSubstituted:t.reqBool(e.fontSubstituted)})},{FromJSONObj:r}}),define("moo/measurement/measurementService",["require","moo/strict","underscore"],function(e){var t=e("moo/strict"),n=e("underscore"),r,i;return r={measureText:function(e,t,n,r,i,s){throw"Interface method"}},i=function(e){var i={};t.requireProtocol(e,r),n.extend(this,{measureText:function(n,r,o,u,a,f){var l,c;return t.reqStr(n),t.reqNum(r),t.reqStr(o),t.reqObj(u),a=t.optNum(a,null),f=t.optNum(f,null),l=n+"_"+r+"_"+o+"_"+u+"_"+a+"_"+f,i[l]?i[l].promise():(c=i[l]=e.measureText(n,r,o,u,a,f),c.fail(function(){delete i[l]}),c.promise())}})},{MeasurementService:r,CachingMeasurementService:i}}),define("moo/measurement",["require","moo/measurement/json","moo/measurement/measurement","moo/measurement/measurementService"],function(e){var t=e("moo/measurement/json"),n=e("moo/measurement/measurement"),r=e("moo/measurement/measurementService");return{jsonParser:t,TextMeasurement:n.TextMeasurement,CachingMeasurementService:r.CachingMeasurementService,MeasurementService:r.MeasurementService}}),function(e){function a(e){return e.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}function f(e){return String(Object.prototype.toString.call(e))==="[object Array]"}function l(t,n){var r={},i,s;if(f(n))for(i=0,s=n.length;i<s;i++)r[n[i]]=!0;else r[n]=!0;for(i=0,s=t.length;i<s;i++)r[t[i]]!==e&&(t.splice(i,1),s--,i--);return t}var t=!1,n=function(e){return t?require("./"+e):window[e]},r=n("punycode"),i=n("IPv6"),s=n("SecondLevelDomains"),o=function(t,n){return this instanceof o?(t===e&&(t=location.href+""),this.href(t),n!==e?this.absoluteTo(n):this):new o(t)},u=o.prototype;o.idn_expression=/[^a-z0-9\.-]/i,o.punycode_expression=/(xn--)/i,o.ip4_expression=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,o.ip6_expression=/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/,o.find_uri_expression=/\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?Â«Â»ââââ]))/ig,o.defaultPorts={http:"80",https:"443",ftp:"21"},o.invalid_hostname_characters=/[^a-zA-Z0-9\.-]/,o.encode=encodeURIComponent,o.decode=decodeURIComponent,o.iso8859=function(){o.encode=escape,o.decode=unescape},o.unicode=function(){o.encode=encodeURIComponent,o.decode=decodeURIComponent},o.characters={pathname:{encode:{expression:/%(24|26|2B|2C|3B|3D|3A|40)/ig,map:{"%24":"$","%26":"&","%2B":"+","%2C":",","%3B":";","%3D":"=","%3A":":","%40":"@"}},decode:{expression:/[\/\?#]/g,map:{"/":"%2F","?":"%3F","#":"%23"}}}},o.encodeQuery=function(e){return o.encode(e+"").replace(/%20/g,"+")},o.decodeQuery=function(e){return o.decode((e+"").replace(/\+/g,"%20"))},o.recodePath=function(e){var t=(e+"").split("/");for(var n=0,r=t.length;n<r;n++)t[n]=o.encodePathSegment(o.decode(t[n]));return t.join("/")},o.decodePath=function(e){var t=(e+"").split("/");for(var n=0,r=t.length;n<r;n++)t[n]=o.decodePathSegment(t[n]);return t.join("/")};var c={encode:"encode",decode:"decode"},h,p=function(e){return function(t){return o[e](t+"").replace(o.characters.pathname[e].expression,function(t){return o.characters.pathname[e].map[t]})}};for(h in c)o[h+"PathSegment"]=p(c[h]);o.parse=function(e){var t,n,r={};return t=e.indexOf("#"),t>-1&&(r.fragment=e.substring(t+1)||null,e=e.substring(0,t)),t=e.indexOf("?"),t>-1&&(r.query=e.substring(t+1)||null,e=e.substring(0,t)),e.substring(0,2)==="//"?(r.protocol="",e=e.substring(2),e=o.parseAuthority(e,r)):(t=e.indexOf(":"),t>-1&&(r.protocol=e.substring(0,t),e.substring(t+1,t+3)==="//"?(e=e.substring(t+3),e=o.parseAuthority(e,r)):(e=e.substring(t+1),r.urn=!0))),r.path=e,r},o.parseHost=function(e,t){var n=e.indexOf("/"),r;n===-1&&(n=e.length);if(e.charAt(0)==="["){var i=e.indexOf("]");t.hostname=e.substring(1,i)||null,t.port=e.substring(i+2,n)||null}else e.indexOf(":")!==e.lastIndexOf(":")?(t.hostname=e.substring(0,n)||null,t.port=null):(r=e.substring(0,n).split(":"),t.hostname=r[0]||null,t.port=r[1]||null);return t.hostname&&e.substring(n).charAt(0)!=="/"&&(n++,e="/"+e),e.substring(n)||"/"},o.parseAuthority=function(e,t){return e=o.parseUserinfo(e,t),o.parseHost(e,t)},o.parseUserinfo=function(e,t){var n=e.indexOf("@"),r=e.indexOf("/"),i;return n>-1&&(r===-1||n<r)?(i=e.substring(0,n).split(":"),t.username=i[0]?o.decode(i[0]):null,t.password=i[1]?o.decode(i[1]):null,e=e.substring(n+1)):(t.username=null,t.password=null),e},o.parseQuery=function(e){if(!e)return{};e=e.replace(/&+/g,"&").replace(/^\?*&*|&+$/g,"");if(!e)return{};var t={},n=e.split("&"),r=n.length;for(var i=0;i<r;i++){var s=n[i].split("="),u=o.decodeQuery(s.shift()),a=s.length?o.decodeQuery(s.join("=")):null;t[u]?(typeof t[u]=="string"&&(t[u]=[t[u]]),t[u].push(a)):t[u]=a}return t},o.build=function(e){var t="";return e.protocol&&(t+=e.protocol+":"),!e.urn&&(t||e.hostname)&&(t+="//"),t+=o.buildAuthority(e)||"",typeof e.path=="string"&&(e.path.charAt(0)!=="/"&&typeof e.hostname=="string"&&(t+="/"),t+=e.path),typeof e.query=="string"&&(t+="?"+e.query),typeof e.fragment=="string"&&(t+="#"+e.fragment),t},o.buildHost=function(e){var t="";return e.hostname?(o.ip6_expression.test(e.hostname)?e.port?t+="["+e.hostname+"]:"+e.port:t+=e.hostname:(t+=e.hostname,e.port&&(t+=":"+e.port)),t):""},o.buildAuthority=function(e){return o.buildUserinfo(e)+o.buildHost(e)},o.buildUserinfo=function(e){var t="";return e.username&&(t+=o.encode(e.username),e.password&&(t+=":"+o.encode(e.password)),t+="@"),t},o.buildQuery=function(t,n){var r="";for(var i in t)if(Object.hasOwnProperty.call(t,i)&&i)if(f(t[i])){var s={};for(var u=0,a=t[i].length;u<a;u++)t[i][u]!==e&&s[t[i][u]+""]===e&&(r+="&"+o.buildQueryParameter(i,t[i][u]),n!==!0&&(s[t[i][u]+""]=!0))}else t[i]!==e&&(r+="&"+o.buildQueryParameter(i,t[i]));return r.substring(1)},o.buildQueryParameter=function(e,t){return o.encodeQuery(e)+(t!==null?"="+o.encodeQuery(t):"")},o.addQuery=function(t,n,r){if(typeof n=="object")for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&o.addQuery(t,i,n[i]);else{if(typeof n!="string")throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");if(t[n]===e){t[n]=r;return}typeof t[n]=="string"&&(t[n]=[t[n]]),f(r)||(r=[r]),t[n]=t[n].concat(r)}},o.removeQuery=function(t,n,r){if(f(n))for(var i=0,s=n.length;i<s;i++)t[n[i]]=e;else if(typeof n=="object")for(var u in n)Object.prototype.hasOwnProperty.call(n,u)&&o.removeQuery(t,u,n[u]);else{if(typeof n!="string")throw new TypeError("URI.addQuery() accepts an object, string as the first parameter");r!==e?t[n]===r?t[n]=e:f(t[n])&&(t[n]=l(t[n],r)):t[n]=e}},o.commonPath=function(e,t){var n=Math.min(e.length,t.length),r;for(r=0;r<n;r++)if(e.charAt(r)!==t.charAt(r)){r--;break}return r<1?e.charAt(0)===t.charAt(0)&&e.charAt(0)==="/"?"/":"":(e.charAt(r)!=="/"&&(r=e.substring(0,r).lastIndexOf("/")),e.substring(0,r+1))},o.withinString=function(e,t){return e.replace(o.find_uri_expression,t)},o.ensureValidHostname=function(e){if(e.match(o.invalid_hostname_characters)){if(!r)throw new TypeError("Hostname '"+e+"' contains characters other than [A-Z0-9.-] and Punycode.js is not available");if(r.toASCII(e).match(o.invalid_hostname_characters))throw new TypeError("Hostname '"+e+"' contains characters other than [A-Z0-9.-]")}},u.build=function(t){if(t===!0)this._deferred_build=!0;else if(t===e||this._deferred_build)this._string=o.build(this._parts),this._deferred_build=!1;return this},u.clone=function(){return new o(this)},u.toString=function(){return this.build(!1)._string},u.valueOf=function(){return this.toString()},c={protocol:"protocol",username:"username",password:"password",hostname:"hostname",port:"port"},p=function(t){return function(n,r){return n===e?this._parts[t]||"":(this._parts[t]=n,this.build(!r),this)}};for(h in c)u[h]=p(c[h]);c={query:"?",fragment:"#"},p=function(t,n){return function(r,i){return r===e?this._parts[t]||"":(r!==null&&(r+="",r.charAt(0)===n&&(r=r.substring(1))),this._parts[t]=r,this.build(!i),this)}};for(h in c)u[h]=p(h,c[h]);c={search:["?","query"],hash:["#","fragment"]},p=function(e,t){return function(n,r){var i=this[e](n,r);return typeof i=="string"&&i.length?t+i:i}};for(h in c)u[h]=p(c[h][1],c[h][0]);u.pathname=function(t,n){if(t===e||t===!0){var r=this._parts.path||(this._parts.urn?"":"/");return t?o.decodePath(r):r}return this._parts.path=t?o.recodePath(t):"/",this.build(!n),this},u.path=u.pathname,u.href=function(t,n){if(t===e)return this.toString();this._string="",this._parts={protocol:null,username:null,password:null,hostname:null,urn:null,port:null,path:null,query:null,fragment:null};var r=t instanceof o,i=typeof t=="object"&&(t.hostname||t.path),s;if(typeof t=="string")this._parts=o.parse(t);else{if(!r&&!i)throw new TypeError("invalid input");var u=r?t._parts:t;for(s in u)Object.hasOwnProperty.call(this._parts,s)&&(this._parts[s]=u[s])}return this.build(!n),this},u.is=function(e){var t=!1,n=!1,r=!1,i=!1,u=!1,a=!1,f=!1,l=!this._parts.urn;this._parts.hostname&&(l=!1,n=o.ip4_expression.test(this._parts.hostname),r=o.ip6_expression.test(this._parts.hostname),t=n||r,i=!t,u=i&&s&&s.has(this._parts.hostname),a=i&&o.idn_expression.test(this._parts.hostname),f=i&&o.punycode_expression.test(this._parts.hostname));switch(e.toLowerCase()){case"relative":return l;case"absolute":return!l;case"domain":case"name":return i;case"sld":return u;case"ip":return t;case"ip4":case"ipv4":case"inet4":return n;case"ip6":case"ipv6":case"inet6":return r;case"idn":return a;case"url":return!this._parts.urn;case"urn":return!!this._parts.urn;case"punycode":return f}return null};var d=u.protocol,v=u.port,m=u.hostname;u.protocol=function(t,n){if(t!==e&&t){t=t.replace(/:(\/\/)?$/,"");if(t.match(/[^a-zA-z0-9\.+-]/))throw new TypeError("Protocol '"+t+"' contains characters other than [A-Z0-9.+-]")}return d.call(this,t,n)},u.scheme=u.protocol,u.port=function(t,n){if(this._parts.urn)return t===e?"":this;if(t!==e){t===0&&(t=null);if(t){t+="",t.charAt(0)===":"&&(t=t.substring(1));if(t.match(/[^0-9]/))throw new TypeError("Port '"+t+"' contains characters other than [0-9]")}}return v.call(this,t,n)},u.hostname=function(t,n){if(this._parts.urn)return t===e?"":this;if(t!==e){var r={};o.parseHost(t,r),t=r.hostname}return m.call(this,t,n)},u.host=function(t,n){return this._parts.urn?t===e?"":this:t===e?this._parts.hostname?o.buildHost(this._parts):"":(o.parseHost(t,this._parts),this.build(!n),this)},u.authority=function(t,n){return this._parts.urn?t===e?"":this:t===e?this._parts.hostname?o.buildAuthority(this._parts):"":(o.parseAuthority(t,this._parts),this.build(!n),this)},u.userinfo=function(t,n){if(this._parts.urn)return t===e?"":this;if(t===e){if(!this._parts.username)return"";var r=o.buildUserinfo(this._parts);return r.substring(0,r.length-1)}return t[t.length-1]!=="@"&&(t+="@"),o.parseUserinfo(t,this._parts),this.build(!n),this},u.subdomain=function(t,n){if(this._parts.urn)return t===e?"":this;if(t===e){if(!this._parts.hostname||this.is("IP"))return"";var r=this._parts.hostname.length-this.domain().length-1;return this._parts.hostname.substring(0,r)||""}var i=this._parts.hostname.length-this.domain().length,s=this._parts.hostname.substring(0,i),u=new RegExp("^"+a(s));return t&&t.charAt(t.length-1)!=="."&&(t+="."),t&&o.ensureValidHostname(t),this._parts.hostname=this._parts.hostname.replace(u,t),this.build(!n),this},u.domain=function(t,n){if(this._parts.urn)return t===e?"":this;typeof t=="boolean"&&(n=t,t=e);if(t===e){if(!this._parts.hostname||this.is("IP"))return"";var r=this._parts.hostname.match(/\./g);if(r&&r.length<2)return this._parts.hostname;var i=this._parts.hostname.length-this.tld(n).length-1;return i=this._parts.hostname.lastIndexOf(".",i-1)+1,this._parts.hostname.substring(i)||""}if(!t)throw new TypeError("cannot set domain empty");o.ensureValidHostname(t);if(!this._parts.hostname||this.is("IP"))this._parts.hostname=t;else{var s=new RegExp(a(this.domain())+"$");this._parts.hostname=this._parts.hostname.replace(s,t)}return this.build(!n),this},u.tld=function(t,n){if(this._parts.urn)return t===e?"":this;typeof t=="boolean"&&(n=t,t=e);if(t===e){if(!this._parts.hostname||this.is("IP"))return"";var r=this._parts.hostname.lastIndexOf("."),i=this._parts.hostname.substring(r+1);return n!==!0&&s&&s.list[i.toLowerCase()]?s.get(this._parts.hostname)||i:i}var o;if(!t)throw new TypeError("cannot set TLD empty");if(t.match(/[^a-zA-Z0-9-]/)){if(!s||!s.is(t))throw new TypeError("TLD '"+t+"' contains characters other than [A-Z0-9]");o=new RegExp(a(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(o,t)}else{if(!this._parts.hostname||this.is("IP"))throw new ReferenceError("cannot set TLD on non-domain host");o=new RegExp(a(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(o,t)}return this.build(!n),this},u.directory=function(t,n){if(this._parts.urn)return t===e?"":this;if(t===e||t===!0){if(!this._parts.path&&!this._parts.hostname)return"";if(this._parts.path==="/")return"/";var r=this._parts.path.length-this.filename().length-1,i=this._parts.path.substring(0,r)||(this._parts.hostname?"/":"");return t?o.decodePath(i):i}var s=this._parts.path.length-this.filename().length,u=this._parts.path.substring(0,s),f=new RegExp("^"+a(u));return this.is("relative")||(t||(t="/"),t.charAt(0)!=="/"&&(t="/"+t)),t&&t.charAt(t.length-1)!=="/"&&(t+="/"),t=o.recodePath(t),this._parts.path=this._parts.path.replace(f,t),this.build(!n),this},u.filename=function(t,n){if(this._parts.urn)return t===e?"":this;if(t===e||t===!0){if(!this._parts.path||this._parts.path==="/")return"";var r=this._parts.path.lastIndexOf("/"),i=this._parts.path.substring(r+1);return t?o.decodePathSegment(i):i}var s=!1;t.charAt(0)==="/"&&(t=t.substring(1)),t.match(/\.?\//)&&(s=!0);var u=new RegExp(a(this.filename())+"$");return t=o.recodePath(t),this._parts.path=this._parts.path.replace(u,t),s?this.normalizePath(n):this.build(!n),this},u.suffix=function(t,n){if(this._parts.urn)return t===e?"":this;if(t===e||t===!0){if(!this._parts.path||this._parts.path==="/")return"";var r=this.filename(),i=r.lastIndexOf("."),s,u;return i===-1?"":(s=r.substring(i+1),u=/^[a-z0-9%]+$/i.test(s)?s:"",t?o.decodePathSegment(u):u)}t.charAt(0)==="."&&(t=t.substring(1));var f=this.suffix(),l;if(!f){if(!t)return this;this._parts.path+="."+o.recodePath(t)}else t?l=new RegExp(a(f)+"$"):l=new RegExp(a("."+f)+"$");return l&&(t=o.recodePath(t),this._parts.path=this._parts.path.replace(l,t)),this.build(!n),this};var g=u.query;u.query=function(t,n){return t===!0?o.parseQuery(this._parts.query):t!==e&&typeof t!="string"?(this._parts.query=o.buildQuery(t),this.build(!n),this):g.call(this,t,n)},u.addQuery=function(e,t,n){var r=o.parseQuery(this._parts.query);return o.addQuery(r,e,t),this._parts.query=o.buildQuery(r),typeof e!="string"&&(n=t),this.build(!n),this},u.removeQuery=function(e,t,n){var r=o.parseQuery(this._parts.query);return o.removeQuery(r,e,t),this._parts.query=o.buildQuery(r),typeof e!="string"&&(n=t),this.build(!n),this},u.addSearch=u.addQuery,u.removeSearch=u.removeQuery,u.normalize=function(){return this._parts.urn?this.normalizeProtocol(!1).normalizeQuery(!1).normalizeFragment(!1).build():this.normalizeProtocol(!1).normalizeHostname(!1).normalizePort(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build()},u.normalizeProtocol=function(e){return typeof this._parts.protocol=="string"&&(this._parts.protocol=this._parts.protocol.toLowerCase(),this.build(!e)),this},u.normalizeHostname=function(e){return this._parts.hostname&&(this.is("IDN")&&r?this._parts.hostname=r.toASCII(this._parts.hostname):this.is("IPv6")&&i&&(this._parts.hostname=i.best(this._parts.hostname)),this._parts.hostname=this._parts.hostname.toLowerCase(),this.build(!e)),this},u.normalizePort=function(e){return typeof this._parts.protocol=="string"&&this._parts.port===o.defaultPorts[this._parts.protocol]&&(this._parts.port=null,this.build(!e)),this},u.normalizePath=function(e){if(this._parts.urn)return this;if(!this._parts.path||this._parts.path==="/")return this;var t,n,r=this._parts.path,i,s;r.charAt(0)!=="/"&&(r.charAt(0)==="."&&(n=r.substring(0,r.indexOf("/"))),t=!0,r="/"+r),r=r.replace(/(\/(\.\/)+)|\/{2,}/g,"/");for(;;){i=r.indexOf("/../");if(i===-1)break;if(i===0){r=r.substring(3);break}s=r.substring(0,i).lastIndexOf("/"),s===-1&&(s=i),r=r.substring(0,s)+r.substring(i+3)}return t&&this.is("relative")&&(n?r=n+r:r=r.substring(1)),r=o.recodePath(r),this._parts.path=r,this.build(!e),this},u.normalizePathname=u.normalizePath,u.normalizeQuery=function(e){return typeof this._parts.query=="string"&&(this._parts.query.length?this.query(o.parseQuery(this._parts.query)):this._parts.query=null,this.build(!e)),this},u.normalizeFragment=function(e){return this._parts.fragment||(this._parts.fragment=null,this.build(!e)),this},u.normalizeSearch=u.normalizeQuery,u.normalizeHash=u.normalizeFragment,u.iso8859=function(){var e=o.encode,t=o.decode;return o.encode=escape,o.decode=decodeURIComponent,this.normalize(),o.encode=e,o.decode=t,this},u.unicode=function(){var e=o.encode,t=o.decode;return o.encode=encodeURIComponent,o.decode=unescape,this.normalize(),o.encode=e,o.decode=t,this},u.readable=function(){var t=this.clone();t.username("").password("").normalize();var n="";t._parts.protocol&&(n+=t._parts.protocol+"://"),t._parts.hostname&&(t.is("punycode")&&r?(n+=r.toUnicode(t._parts.hostname),t._parts.port&&(n+=":"+t._parts.port)):n+=t.host()),t._parts.hostname&&t._parts.path&&t._parts.path.charAt(0)!=="/"&&(n+="/"),n+=t.path(!0);if(t._parts.query){var i="";for(var s=0,u=t._parts.query.split("&"),a=u.length;s<a;s++){var f=(u[s]||"").split("=");i+="&"+o.decodeQuery(f[0]).replace(/&/g,"%26"),f[1]!==e&&(i+="="+o.decodeQuery(f[1]).replace(/&/g,"%26"))}n+="?"+i.substring(1)}return n+=t.hash(),n},u.absoluteTo=function(e){var t=this.clone(),n=["protocol","username","password","hostname","port"],r;if(this._parts.urn)throw new Error("URNs do not have any generally defined hierachical components");if(this._parts.hostname)return t;e instanceof o||(e=new o(e));for(var i=0,s;s=n[i];i++)t._parts[s]=e._parts[s];return t.path().charAt(0)!=="/"&&(r=e.directory(),t._parts.path=(r?r+"/":"")+t._parts.path,t.normalizePath()),t.build(),t},u.relativeTo=function(e){var t=this.clone(),n=["protocol","username","password","hostname","port"],r,i;if(this._parts.urn)throw new Error("URNs do not have any generally defined hierachical components");e instanceof o||(e=new o(e));if(this.path().charAt(0)!=="/"||e.path().charAt(0)!=="/")throw new Error("Cannot calculate common path from non-relative URLs");r=o.commonPath(t.path(),e.path()),i=e.directory();for(var s=0,u;u=n[s];s++)t._parts[u]=null;if(!r||r==="/")return t;if(i+"/"===r)t._parts.path="./"+t.filename();else{var f="../",l=new RegExp("^"+a(r)),c=i.replace(l,"/").match(/\//g).length-1;while(c--)f+="../";t._parts.path=t._parts.path.replace(l,f)}return t.build(),t},u.equals=function(e){var t=this.clone(),n=new o(e),r={},i={},s={},u,a,l;t.normalize(),n.normalize();if(t.toString()===n.toString())return!0;u=t.query(),a=n.query(),t.query(""),n.query("");if(t.toString()!==n.toString())return!1;if(u.length!==a.length)return!1;r=o.parseQuery(u),i=o.parseQuery(a);for(l in r)if(Object.prototype.hasOwnProperty.call(r,l)){if(!f(r[l])){if(r[l]!==i[l])return!1}else{if(!f(i[l]))return!1;if(r[l].length!==i[l].length)return!1;r[l].sort(),i[l].sort();for(var c=0,h=r[l].length;c<h;c++)if(r[l][c]!==i[l][c])return!1}s[l]=!0}for(l in i)if(Object.prototype.hasOwnProperty.call(i,l)&&!s[l])return!1;return!0},window.URI=o}(),define("URI",[],function(){return URI}),define("moo/api",["require","underscore","moo/pack/json","moo/strict","jquery","moo/measurement","URI","moo/log"],function(e){function c(){var e=i("html"),t=e.attr("lang")||e.attr("xml:lang")||"en",n="";return t!=="en"&&(n="/"+t),n}var t=e("underscore"),n=e("moo/pack/json"),r=e("moo/strict"),i=e("jquery"),s=e("moo/measurement"),o=e("URI"),u=e("moo/log"),a,f,l;return a=function(e,n){var r,i=e.formToken,s="/api/service/",o=c();return this===window||this===undefined?new a(e,n):(r=this,t.extend(r,{createPromiseForAPICall:function(e,t,r,u){var a=!1;return r=r||"application/x-www-form-urlencoded",u=u||"json",a||(t.formToken=i),o!==""&&(t.languageCode=o),n.ajax({url:s,cache:!1,type:e,contentType:r,dataType:u,data:t})},formToken:function(){return i},endPoint:function(){return s}}),r)},t.extend(a.prototype,{importImage:function(e,t,s){return this.createPromiseForAPICall("POST",{method:"moo.image.importImage",imageUrl:e,source:t,name:s,includeTrueImageBox:"true"}).pipe(function(e,t,s){var o=new n.FromJSONObj;try{e.imageBasketItem=o.toImageBasketItem(e.imageBasketItem),r.requireImageBasketItem(e.imageBasketItem)}catch(u){return i.Deferred().reject({exception:{message:"Unexpected response from server"}})}return e},function(e){var t=l.findErrorInResponse(e)||"Unknown error";return{exception:{message:t}}})},getUploadImageParams:function(e,t){return{method:"moo.image.uploadImage",formToken:this.formToken(),source:e,name:t,includeTrueImageBox:"true"}},getPack:function(e,t){return this.createPromiseForAPICall("GET",{method:"moo.pack.getPack",packId:e,includePhysicalSpec:!!t}).pipe(function(e,t,r){var i=new n.FromJSONObj;return e.pack=i.toPack(e.pack),e.physicalSpec&&(e.physicalSpec=i.toPhysicalSpec(e.physicalSpec)),e})},updatePack:function(e,t){var r=new n.ToJSONObj;return this.createPromiseForAPICall("POST",{method:"moo.pack.updatePack",packId:e,pack:JSON.stringify(r.toPack(t))}).pipe(function(e,t,r){var i=new n.FromJSONObj;return e.pack=i.toPack(e.pack),e})},createPack:function(e,t){var r=new n.ToJSONObj;return this.createPromiseForAPICall("POST",{method:"moo.pack.createPack",product:t,pack:JSON.stringify(r.toPack(e))}).pipe(function(e,t,r){var i=new n.FromJSONObj;return e.pack=i.toPack(e.pack),e})},updatePhysicalSpec:function(e,t){var r=new n.ToJSONObj;return this.createPromiseForAPICall("POST",{method:"moo.pack.updatePhysicalSpec",packId:e,physicalSpec:JSON.stringify(r.toPhysicalSpec(t))}).pipe(function(e,t,r){var i=new n.FromJSONObj;return e.physicalSpec=i.toPhysicalSpec(e.physicalSpec),e})},getQuantityPrice:function(e,t,r,i){var s=new n.ToJSONObj,o;return o={method:"moo.price.getQuantityPrice",physicalSpec:JSON.stringify(s.toPhysicalSpec(e)),currencyCode:r,storeCode:i,quantity:t},this.createPromiseForAPICall("GET",o)},measureText:function(e,t,i,o,u,a){var f=new n.ToJSONObj,l;return r.reqStr(e),r.reqNum(t),r.reqStr(i),r.reqObj(o),l={method:"moo.text.measure",text:e,fontSize:t,fontSizeUnits:i,font:JSON.stringify(f.toFont(o))},u!==null&&(l.wrappingWidth=u),a!==null&&(l.leading=a),this.createPromiseForAPICall("GET",l).pipe(function(e,t,n){var r=new s.jsonParser.FromJSONObj;return r.toTextMeasurement(e)})}}),f=function(e){return e.ajax({url:"/ajaxrequests/get_form_token.php",type:"POST",dataType:"text"})},l={findErrorInResponse:function(e){var t;if(e){if(e.uploadImageError&&e.uploadImageError.message)return e.uploadImageError.message;if(e.responseText)try{t=i.parseJSON(e.responseText);if(t&&t.exception&&t.exception.message)return t.exception.message}catch(n){}}return undefined}},{Api:a,fetchFormToken:f,util:l}}),define("moo/pack/derive",["underscore","basilisk","moo/log"],function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;return s=function(t){var n=function(n,r){return n===r?n:e.isObject(n)?e.isObject(r)?t.apply(this,arguments):null:r};return n},o=s(function(e,t){return Math.abs(e-t)<1e-4?e:t}),i=s(function(r,i,s,o){var u=[],a=[],f=!1;return i.each(function(e){var t=o(e),i;i=null,u.push(t),r.each(function(r){t===o(r)&&(i=s(r,e),i!==r&&(n.debug("Map key difference @ ",t),f=!0),u.push(t),a.push(i))}),i===null&&(n.debug("New object @ ",t),f=!0,u.push(t),a.push(e))}),r.each(function(t){var r=o(t);e.indexOf(u,r)===-1&&(n.debug("Removed key @ ",r),f=!0)}),f?t.collections.ForwardList.from(a):r}),u=a=f=s(function(e,t){if(t.prototype!==e.prototype)throw"Objects must have the same prototype.";return t.equals(e)?e:e.with_(t)}),y=s(function(e,t){var n=function(e){return e.key},r=function(e,t){return e.withValue(t.value)};return i(e,t,r,n)}),d=s(function(e,t){return e.with_({templateCode:t.templateCode,data:g(e.data,t.data)})}),v=s(function(e,t){var n=function(e){return e.sideNum+"|"+e.type};return i(e,t,d,n)}),g=function(e,t){var n=function(e){return e.linkId};return i(e,t,p,n)},p=s(function(t,n){var r={textData:function(e,t){return e.with_({text:t.text,alignment:t.alignment,pointSize:o(e.pointSize,t.pointSize),font:f(e.font,t.font),colour:a(e.colour,t.colour)})},multiLineTextData:function(e,t){return e.with_({text:t.text,alignment:t.alignment,pointSize:o(e.pointSize,t.pointSize),font:f(e.font,t.font),colour:a(e.colour,t.colour)})},imageData:function(e,t){return e.with_({resourceUri:t.resourceUri,imageStoreFileId:t.imageStoreFileId,enhance:t.enhance,imageBox:u(e.imageBox,t.imageBox)})},fixedImageData:function(e,t){return e.with_(t)},boxData:function(e,t){return e.with_({colour:a(e.colour,t.colour)})}};if(t.linkId!==n.linkId)throw"Datums MUST share a linkId";if(t.type!==n.type)throw"Cannot diff datums with different types.";if(!e.has(r,t.type))throw"Unknown type "+t.type;return r[t.type](t,n)}),m=function(e,t){var n=function(e){return e.cardNum},r=s(function(e,t){return e.with_({cardSides:i(e.cardSides,t.cardSides,function(e,t){return e.with_(t)},function(e){return e.sideType})})});return i(e,t,r,n)},c=s(function(e,t){var n=function(e){return e.type},r;return e.name!==undefined&&e.name!==null||t.name!==undefined&&t.name!==null?r=t.name:r=e.name,e.with_({resourceUri:t.resourceUri,removable:t.removable,croppable:t.croppable,cacheId:t.cacheId,shouldEnhance:t.shouldEnhance,name:r,source:t.source,imageBox:u(e.imageBox,t.imageBox),imageItems:i(e.imageItems,t.imageItems,h,n)})}),h=s(function(e,t){return e.with_({type:t.type,resourceUri:t.resourceUri,width:o(e.width,t.width),height:o(e.height,t.height),rotation:o(e.rotation,t.rotation)})}),l=function(e,t){var n=function(e){return e.resourceUri};return e.with_({immutable:t.immutable,name:t.name,type:t.type,items:i(e.items,t.items,c,n)})},b=s(function(e,t){return e.with_({packId:t.packId,productCode:t.productCode,productVersion:t.productVersion,numCards:t.numCards,imageBasket:l(e.imageBasket,t.imageBasket),sides:v(e.sides,t.sides),extras:y(e.extras,t.extras),cards:m(e.cards,t.cards)})}),r=function(e,t){return b(e,t)},{derive:r,_testing:{_deriveImageBasket:l,_deriveSides:v,_deriveData:g,_deriveExtras:y,_derivePack:b}}}),define("domReady",[],function(){function u(e){var t;for(t=0;t<e.length;t+=1)e[t](s)}function a(){var e=o;i&&e.length&&(o=[],u(e))}function f(){i||(i=!0,n&&clearInterval(n),a())}function c(e){return i?e(s):o.push(e),c}var e,t,n,r=typeof window!="undefined"&&window.document,i=!r,s=r?document:null,o=[];if(r){if(document.addEventListener)document.addEventListener("DOMContentLoaded",f,!1),window.addEventListener("load",f,!1);else if(window.attachEvent){window.attachEvent("onload",f),t=document.createElement("div");try{e=window.frameElement===null}catch(l){}t.doScroll&&e&&window.external&&(n=setInterval(function(){try{t.doScroll(),f()}catch(e){}},30))}document.readyState==="complete"&&f()}return c.version="2.0.1",c.load=function(e,t,n,r){r.isBuild?n(null):c(n)},c}),function(){var e=this,t=e.Backbone,n=Array.prototype.slice,r=Array.prototype.splice,i;typeof exports!="undefined"?i=exports:i=e.Backbone={},i.VERSION="0.9.2";var s=e._;!s&&typeof require!="undefined"&&(s=require("underscore"));var o=e.jQuery||e.Zepto||e.ender;i.setDomLibrary=function(e){o=e},i.noConflict=function(){return e.Backbone=t,this},i.emulateHTTP=!1,i.emulateJSON=!1;var u=/\s+/,a=i.Events={on:function(e,t,n){var r,i,s,o,a;if(!t)return this;e=e.split(u),r=this._callbacks||(this._callbacks={});while(i=e.shift())a=r[i],s=a?a.tail:{},s.next=o={},s.context=n,s.callback=t,r[i]={tail:o,next:a?a.next:s};return this},off:function(e,t,n){var r,i,o,a,f,l;if(!(i=this._callbacks))return;if(!(e||t||n))return delete this._callbacks,this;e=e?e.split(u):s.keys(i);while(r=e.shift()){o=i[r],delete i[r];if(!o||!t&&!n)continue;a=o.tail;while((o=o.next)!==a)f=o.callback,l=o.context,(t&&f!==t||n&&l!==n)&&this.on(r,f,l)}return this},trigger:function(e){var t,r,i,s,o,a,f;if(!(i=this._callbacks))return this;a=i.all,e=e.split(u),f=n.call(arguments,1);while(t=e.shift()){if(r=i[t]){s=r.tail;while((r=r.next)!==s)r.callback.apply(r.context||this,f)}if(r=a){s=r.tail,o=[t].concat(f);while((r=r.next)!==s)r.callback.apply(r.context||this,o)}}return this}};a.bind=a.on,a.unbind=a.off;var f=i.Model=function(e,t){var n;e||(e={}),t&&t.parse&&(e=this.parse(e));if(n=C(this,"defaults"))e=s.extend({},n,e);t&&t.collection&&(this.collection=t.collection),this.attributes={},this._escapedAttributes={},this.cid=s.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(e,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=s.clone(this.attributes),this.initialize.apply(this,arguments)};s.extend(f.prototype,a,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return s.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var t;if(t=this._escapedAttributes[e])return t;var n=this.get(e);return this._escapedAttributes[e]=s.escape(n==null?"":""+n)},has:function(e){return this.get(e)!=null},set:function(e,t,n){var r,i,o;s.isObject(e)||e==null?(r=e,n=t):(r={},r[e]=t),n||(n={});if(!r)return this;r instanceof f&&(r=r.attributes);if(n.unset)for(i in r)r[i]=void 0;if(!this._validate(r,n))return!1;this.idAttribute in r&&(this.id=r[this.idAttribute]);var u=n.changes={},a=this.attributes,l=this._escapedAttributes,c=this._previousAttributes||{};for(i in r){o=r[i];if(!s.isEqual(a[i],o)||n.unset&&s.has(a,i))delete l[i],(n.silent?this._silent:u)[i]=!0;n.unset?delete a[i]:a[i]=o,!s.isEqual(c[i],o)||s.has(a,i)!=s.has(c,i)?(this.changed[i]=o,n.silent||(this._pending[i]=!0)):(delete this.changed[i],delete this._pending[i])}return n.silent||this.change(n),this},unset:function(e,t){return(t||(t={})).unset=!0,this.set(e,null,t)},clear:function(e){return(e||(e={})).unset=!0,this.set(s.clone(this.attributes),e)},fetch:function(e){e=e?s.clone(e):{};var t=this,n=e.success;return e.success=function(r,i,s){if(!t.set(t.parse(r,s),e))return!1;n&&n(t,r)},e.error=i.wrapError(e.error,t,e),(this.sync||i.sync).call(this,"read",this,e)},save:function(e,t,n){var r,o;s.isObject(e)||e==null?(r=e,n=t):(r={},r[e]=t),n=n?s.clone(n):{};if(n.wait){if(!this._validate(r,n))return!1;o=s.clone(this.attributes)}var u=s.extend({},n,{silent:!0});if(r&&!this.set(r,n.wait?u:n))return!1;var a=this,f=n.success;n.success=function(e,t,i){var o=a.parse(e,i);n.wait&&(delete n.wait,o=s.extend(r||{},o));if(!a.set(o,n))return!1;f?f(a,e):a.trigger("sync",a,e,n)},n.error=i.wrapError(n.error,a,n);var l=this.isNew()?"create":"update",c=(this.sync||i.sync).call(this,l,this,n);return n.wait&&this.set(o,u),c},destroy:function(e){e=e?s.clone(e):{};var t=this,n=e.success,r=function(){t.trigger("destroy",t,t.collection,e)};if(this.isNew())return r(),!1;e.success=function(i){e.wait&&r(),n?n(t,i):t.trigger("sync",t,i,e)},e.error=i.wrapError(e.error,t,e);var o=(this.sync||i.sync).call(this,"delete",this,e);return e.wait||r(),o},url:function(){var e=C(this,"urlRoot")||C(this.collection,"url")||k();return this.isNew()?e:e+(e.charAt(e.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(e){e||(e={});var t=this._changing;this._changing=!0;for(var n in this._silent)this._pending[n]=!0;var r=s.extend({},e.changes,this._silent);this._silent={};for(var n in r)this.trigger("change:"+n,this,this.get(n),e);if(t)return this;while(!s.isEmpty(this._pending)){this._pending={},this.trigger("change",this,e);for(var n in this.changed){if(this._pending[n]||this._silent[n])continue;delete this.changed[n]}this._previousAttributes=s.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(e){return arguments.length?s.has(this.changed,e):!s.isEmpty(this.changed)},changedAttributes:function(e){if(!e)return this.hasChanged()?s.clone(this.changed):!1;var t,n=!1,r=this._previousAttributes;for(var i in e){if(s.isEqual(r[i],t=e[i]))continue;(n||(n={}))[i]=t}return n},previous:function(e){return!arguments.length||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return s.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(e,t){if(t.silent||!this.validate)return!0;e=s.extend({},this.attributes,e);var n=this.validate(e,t);return n?(t&&t.error?t.error(this,n,t):this.trigger("error",this,n,t),!1):!0}});var l=i.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})};s.extend(l.prototype,a,{model:f,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},add:function(e,t){var n,i,o,u,a,f,l={},c={},h=[];t||(t={}),e=s.isArray(e)?e.slice():[e];for(n=0,o=e.length;n<o;n++){if(!(u=e[n]=this._prepareModel(e[n],t)))throw new Error("Can't add an invalid model to a collection");a=u.cid,f=u.id;if(l[a]||this._byCid[a]||f!=null&&(c[f]||this._byId[f])){h.push(n);continue}l[a]=c[f]=u}n=h.length;while(n--)e.splice(h[n],1);for(n=0,o=e.length;n<o;n++)(u=e[n]).on("all",this._onModelEvent,this),this._byCid[u.cid]=u,u.id!=null&&(this._byId[u.id]=u);this.length+=o,i=t.at!=null?t.at:this.models.length,r.apply(this.models,[i,0].concat(e)),this.comparator&&this.sort({silent:!0});if(t.silent)return this;for(n=0,o=this.models.length;n<o;n++){if(!l[(u=this.models[n]).cid])continue;t.index=n,u.trigger("add",u,this,t)}return this},remove:function(e,t){var n,r,i,o;t||(t={}),e=s.isArray(e)?e.slice():[e];for(n=0,r=e.length;n<r;n++){o=this.getByCid(e[n])||this.get(e[n]);if(!o)continue;delete this._byId[o.id],delete this._byCid[o.cid],i=this.indexOf(o),this.models.splice(i,1),this.length--,t.silent||(t.index=i,o.trigger("remove",o,this,t)),this._removeReference(o)}return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,t),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,s.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return s.isEmpty(e)?[]:this.filter(function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},sort:function(e){e||(e={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var t=s.bind(this.comparator,this);return this.comparator.length==1?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return s.map(this.models,function(t){return t.get(e)})},reset:function(e,t){e||(e=[]),t||(t={});for(var n=0,r=this.models.length;n<r;n++)this._removeReference(this.models[n]);return this._reset(),this.add(e,s.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(e){e=e?s.clone(e):{},e.parse===undefined&&(e.parse=!0);var t=this,n=e.success;return e.success=function(r,i,s){t[e.add?"add":"reset"](t.parse(r,s),e),n&&n(t,r)},e.error=i.wrapError(e.error,t,e),(this.sync||i.sync).call(this,"read",this,e)},create:function(e,t){var n=this;t=t?s.clone(t):{},e=this._prepareModel(e,t);if(!e)return!1;t.wait||n.add(e,t);var r=t.success;return t.success=function(i,s,o){t.wait&&n.add(i,t),r?r(i,s):i.trigger("sync",e,s,t)},e.save(null,t),e},parse:function(e,t){return e},chain:function(){return s(this.models).chain()},_reset:function(e){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){t||(t={});if(e instanceof f)e.collection||(e.collection=this);else{var n=e;t.collection=this,e=new this.model(n,t),e._validate(e.attributes,t)||(e=!1)}return e},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e=="add"||e=="remove")&&n!=this)return;e=="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],this._byId[t.id]=t),this.trigger.apply(this,arguments)}});var c=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];s.each(c,function(e){l.prototype[e]=function(){return s[e].apply(s,[this.models].concat(s.toArray(arguments)))}});var h=i.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},p=/:\w+/g,d=/\*\w+/g,v=/[-[\]{}()+?.,\\^$|#\s]/g;s.extend(h.prototype,a,{initialize:function(){},route:function(e,t,n){return i.history||(i.history=new m),s.isRegExp(e)||(e=this._routeToRegExp(e)),n||(n=this[t]),i.history.route(e,s.bind(function(r){var s=this._extractParameters(e,r);n&&n.apply(this,s),this.trigger.apply(this,["route:"+t].concat(s)),i.history.trigger("route",this,t,s)},this)),this},navigate:function(e,t){i.history.navigate(e,t)},_bindRoutes:function(){if(!this.routes)return;var e=[];for(var t in this.routes)e.unshift([t,this.routes[t]]);for(var n=0,r=e.length;n<r;n++)this.route(e[n][0],e[n][1],this[e[n][1]])},_routeToRegExp:function(e){return e=e.replace(v,"\\$&").replace(p,"([^/]+)").replace(d,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var m=i.History=function(){this.handlers=[],s.bindAll(this,"checkUrl")},g=/^[#\/]/,y=/msie [\w.]+/;m.started=!1,s.extend(m.prototype,a,{interval:50,getHash:function(e){var t=e?e.location:window.location,n=t.href.match(/#(.*)$/);return n?n[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||t){e=window.location.pathname;var n=window.location.search;n&&(e+=n)}else e=this.getHash();return e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(g,"")},start:function(e){if(m.started)throw new Error("Backbone.history has already been started");m.started=!0,this.options=s.extend({},{root:"/"},this.options,e),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var t=this.getFragment(),n=document.documentMode,r=y.exec(navigator.userAgent.toLowerCase())&&(!n||n<=7);r&&(this.iframe=o('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?o(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?o(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var i=window.location,u=i.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!u)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&u&&i.hash&&(this.fragment=this.getHash().replace(g,""),window.history.replaceState({},document.title,i.protocol+"//"+i.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},stop:function(){o(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),m.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t==this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t==this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),n=s.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return n},navigate:function(e,t){if(!m.started)return!1;if(!t||t===!0)t={trigger:t};var n=(e||"").replace(g,"");if(this.fragment==n)return;this._hasPushState?(n.indexOf(this.options.root)!=0&&(n=this.options.root+n),this.fragment=n,window.history[t.replace?"replaceState":"pushState"]({},document.title,n)):this._wantsHashChange?(this.fragment=n,this._updateHash(window.location,n,t.replace),this.iframe&&n!=this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace))):window.location.assign(this.options.root+e),t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){n?e.replace(e.toString().replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}});var b=i.View=function(e){this.cid=s.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},w=/^(\S+)\s*(.*)$/,E=["model","collection","el","id","attributes","className","tagName"];s.extend(b.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,n){var r=document.createElement(e);return t&&o(r).attr(t),n&&o(r).html(n),r},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof o?e:o(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=C(this,"events")))return;this.undelegateEvents();for(var t in e){var n=e[t];s.isFunction(n)||(n=this[e[t]]);if(!n)throw new Error('Method "'+e[t]+'" does not exist');var r=t.match(w),i=r[1],o=r[2];n=s.bind(n,this),i+=".delegateEvents"+this.cid,o===""?this.$el.bind(i,n):this.$el.delegate(o,i,n)}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=s.extend({},this.options,e));for(var t=0,n=E.length;t<n;t++){var r=E[t];e[r]&&(this[r]=e[r])}this.options=e},_ensureElement:function(){if(!this.el){var e=C(this,"attributes")||{};this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(this.tagName,e),!1)}else this.setElement(this.el,!1)}});var S=function(e,t){var n=N(this,e,t);return n.extend=this.extend,n};f.extend=l.extend=h.extend=b.extend=S;var x={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};i.sync=function(e,t,n){var r=x[e];n||(n={});var u={type:r,dataType:"json"};return n.url||(u.url=C(t,"url")||k()),!n.data&&t&&(e=="create"||e=="update")&&(u.contentType="application/json",u.data=JSON.stringify(t.toJSON())),i.emulateJSON&&(u.contentType="application/x-www-form-urlencoded",u.data=u.data?{model:u.data}:{}),i.emulateHTTP&&(r==="PUT"||r==="DELETE")&&(i.emulateJSON&&(u.data._method=r),u.type="POST",u.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",r)}),u.type!=="GET"&&!i.emulateJSON&&(u.processData=!1),o.ajax(s.extend(u,n))},i.wrapError=function(e,t,n){return function(r,i){i=r===t?i:r,e?e(t,i,n):t.trigger("error",t,i,n)}};var T=function(){},N=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},s.extend(r,e),T.prototype=e.prototype,r.prototype=new T,t&&s.extend(r.prototype,t),n&&s.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r},C=function(e,t){return!e||!e[t]?null:s.isFunction(e[t])?e[t]():e[t]},k=function(){throw new Error('A "url" property or function must be specified')}}.call(this),define("backbone",["jquery"],function(){var e=require("jquery");return Backbone.setDomLibrary(e),Backbone});